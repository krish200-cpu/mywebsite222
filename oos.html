<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Live Studio | FuneralMatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --bg: #050505;
            --surface: #121212;
            --border: #222;
            --gold: #D4AF37;
            --gold-glow: rgba(212, 175, 55, 0.2);
            --page-ratio: 1.414;
            --radius-lg: 24px;
        }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* --- 2. STICKY HEADER --- */
        .top-bar {
            position: sticky; top: 0; z-index: 50;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }

        /* --- 3. SCROLLING WORKSPACE --- */
        .workspace {
            width: 100%; max-width: 500px; margin: 0 auto;
            padding: 30px 20px 140px 20px;
            display: flex; flex-direction: column; gap: 40px;
            position: relative;
        }

        /* The Page Card */
        .page-card {
            width: 100%; aspect-ratio: 1 / var(--page-ratio);
            background: white; color: black;
            position: relative;
            border-radius: 4px; /* Crisp paper edge */
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Active State */
        .page-card.active {
            box-shadow: 0 0 0 3px var(--gold), 0 30px 80px -20px rgba(0,0,0,0.8);
            transform: scale(1.01);
            z-index: 10;
        }

        .page-label {
            position: absolute; top: -25px; left: 0;
            font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #666;
            display: flex; align-items: center; gap: 8px;
        }

        /* Floating Layout Button */
        .layout-trigger {
            position: absolute; top: 10px; right: 10px;
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(0,0,0,0.05); color: #333;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: 0.2s; z-index: 20;
        }
        .page-card:hover .layout-trigger, .page-card.active .layout-trigger { opacity: 1; }
        .layout-trigger:hover { background: var(--gold); color: white; }

        /* --- 4. LIVE EDITING ZONES --- */
        .content-layer { flex: 1; padding: 30px; display: flex; flex-direction: column; position: relative; }

        /* The Magic: ContentEditable Styling */
        [contenteditable="true"] {
            outline: none; border: 1px dashed transparent; transition: 0.2s;
            cursor: text; min-height: 1em; border-radius: 4px;
        }
        [contenteditable="true"]:hover { border-color: rgba(212, 175, 55, 0.5); background: rgba(0,0,0,0.02); }
        [contenteditable="true"]:focus { 
            border-color: var(--gold); background: rgba(212, 175, 55, 0.1); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* Fix empty states */
        [contenteditable="true"]:empty:before { content: attr(placeholder); color: #ccc; pointer-events: none; }

        .photo-zone {
            background: #f4f4f4; width: 100%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; color: #ccc; transition: 0.2s;
        }
        .photo-zone:hover { opacity: 0.8; box-shadow: inset 0 0 0 2px var(--gold); }
        .photo-zone img { width: 100%; height: 100%; object-fit: cover; }

        /* --- 5. MINI-MAP NAVIGATOR (Right Side) --- */
        .mini-map {
            position: fixed; top: 50%; right: 10px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 12px;
            z-index: 40;
        }
        .nav-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #333;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .nav-dot.active { background: var(--gold); transform: scale(1.5); }
        /* Tooltip */
        .nav-dot:hover::after {
            content: attr(data-label); position: absolute; right: 15px; top: -4px;
            background: #222; color: white; padding: 2px 6px; border-radius: 4px;
            font-size: 9px; white-space: nowrap; pointer-events: none;
        }

        /* --- 6. BOTTOM DOCK (Glass) --- */
        .dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 99px;
            padding: 8px 12px;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 60;
        }

        .dock-btn {
            height: 44px; padding: 0 20px; border-radius: 99px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s;
            color: #aaa; border: 1px solid transparent;
        }
        .dock-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .dock-btn.primary { background: var(--gold); color: black; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .dock-btn.primary:hover { background: white; }

        /* --- 7. PREVIEW MODAL --- */
        #preview-modal {
            position: fixed; inset: 0; background: #050505; z-index: 100;
            display: none; flex-direction: column; opacity: 0; transition: opacity 0.5s;
        }
        #preview-modal.open { display: flex; opacity: 1; }
        .spine { width: 340px; height: 480px; position: relative; perspective: 1500px; }
        .sheet-3d {
            position: absolute; inset: 0; background: white; backface-visibility: hidden;
            transform-origin: left center; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: inset 10px 0 20px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .sheet-3d.flipped { transform: rotateY(-180deg); }

        /* --- 8. LAYOUT MENU (Popover) --- */
        #layout-menu {
            position: absolute; background: #1a1a1a; border: 1px solid #333;
            border-radius: 12px; padding: 8px; width: 140px;
            display: none; flex-direction: column; gap: 4px; z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #layout-menu.open { display: flex; }
        .menu-item {
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 10px; color: #ccc;
            text-transform: uppercase; font-weight: 600;
        }
        .menu-item:hover { background: #333; color: white; }
        .menu-item i { width: 16px; text-align: center; color: var(--gold); }

        /* Typography */
        .font-classic { font-family: 'Bodoni Moda', serif; }
        .font-modern { font-family: 'Inter', sans-serif; font-weight: 600; text-transform: uppercase; }
        .font-script { font-family: 'Cormorant Garamond', serif; font-style: italic; }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="flex flex-col">
            <span class="text-[9px] uppercase font-bold text-[#D4AF37] tracking-widest">FuneralMatch</span>
            <span class="text-xs font-bold text-white">Live Editor</span>
        </div>
        <div class="flex items-center gap-4">
             <div class="flex bg-[#1a1a1a] rounded-full p-1 border border-[#222]">
                <button onclick="setTheme('classic')" class="w-6 h-6 rounded-full text-[10px] text-white hover:bg-[#333] font-serif">Aa</button>
                <button onclick="setTheme('modern')" class="w-6 h-6 rounded-full text-[10px] text-white hover:bg-[#333] font-sans font-bold">Aa</button>
                <button onclick="setTheme('script')" class="w-6 h-6 rounded-full text-[10px] text-white hover:bg-[#333] italic">Aa</button>
            </div>
            <span id="price-tag" class="text-xs font-bold text-[#D4AF37]">£80.00</span>
        </div>
    </div>

    <div class="workspace" id="workspace">
        </div>

    <div class="mini-map" id="mini-map">
        </div>

    <div id="layout-menu">
        <div class="menu-item" onclick="applyLayout('cover')"><i class="fas fa-book"></i> Cover</div>
        <div class="menu-item" onclick="applyLayout('text')"><i class="fas fa-align-left"></i> Text</div>
        <div class="menu-item" onclick="applyLayout('photo')"><i class="fas fa-image"></i> Photo</div>
        <div class="menu-item" onclick="applyLayout('hymn')"><i class="fas fa-music"></i> Hymn</div>
    </div>

    <div class="dock">
        <button class="dock-btn" onclick="addPages()">
            <i class="fas fa-plus"></i> <span class="hidden sm:inline">Pages</span>
        </button>
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <button class="dock-btn" onclick="openPreview()">
            <i class="fas fa-eye"></i> <span>Preview</span>
        </button>
        <button class="dock-btn primary" onclick="alert('Proceeding to Cart')">
            <span>Print</span> <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <div id="preview-overlay">
        <div class="absolute top-0 left-0 right-0 p-6 flex justify-between items-center z-50">
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Booklet Preview</span>
            <button onclick="closePreview()" class="w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20"><i class="fas fa-times"></i></button>
        </div>
        <div class="book-stage">
            <div id="book-spine" class="spine"></div>
        </div>
        <div class="absolute bottom-10 w-full flex justify-center gap-8 text-2xl text-white/50">
            <button onclick="flipBack()" class="hover:text-white"><i class="fas fa-chevron-left"></i></button>
            <button onclick="flipForward()" class="hover:text-white"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <input type="file" id="img-upload" class="hidden" accept="image/*">

    <script>
        // === CONFIG ===
        const TEMPLATES = {
            cover: `
                <div class="h-full flex flex-col items-center justify-center text-center">
                    <div class="mb-6 outline-none" contenteditable="true" placeholder="In Loving Memory">In Loving Memory of</div>
                    <div class="photo-zone rounded-full w-40 h-40 mb-6 border-[6px] border-double border-gray-100" onclick="upload(this)">
                        <i class="fas fa-camera text-2xl opacity-20"></i>
                    </div>
                    <div class="text-4xl mb-2 leading-tight font-serif outline-none" contenteditable="true" placeholder="Name">Name<br>Here</div>
                    <div class="text-sm mb-6 text-gray-500 font-serif italic outline-none" contenteditable="true">1950 — 2026</div>
                    <div class="mt-auto text-[9px] uppercase font-bold text-gray-400 tracking-widest outline-none" contenteditable="true">St Mary's Church</div>
                </div>`,
            
            text: `
                <div class="h-full p-8 text-left">
                    <div class="text-lg font-bold mb-6 border-b border-gray-100 pb-4 text-[#D4AF37] outline-none" contenteditable="true">Reading</div>
                    <div class="text-sm leading-loose text-gray-600 outline-none" contenteditable="true">
Tap here to type directly on the page. 
You can add poems, eulogies, or order of service details.
                    </div>
                </div>`,
            
            hymn: `
                 <div class="h-full flex flex-col items-center justify-start pt-12 text-center px-6">
                    <div class="text-[9px] uppercase font-bold text-gray-300 mb-4 tracking-widest outline-none" contenteditable="true">Hymn</div>
                    <div class="text-2xl italic mb-8 font-serif outline-none" contenteditable="true">Abide With Me</div>
                    <div class="text-xs font-serif italic text-gray-500 leading-loose outline-none" contenteditable="true">
Abide with me;<br>fast falls the eventide;<br>The darkness deepens;<br>Lord with me abide.<br>When other helpers fail<br>and comforts flee,<br>Help of the helpless,<br>O abide with me.
                    </div>
                </div>`
        };

        const state = {
            pageCount: 4,
            pages: [],
            theme: 'classic',
            previewIdx: 0
        };

        // === CORE ===
        function init() {
            resetPages(4);
            // Add scroll listener for mini-map highlight
            document.getElementById('workspace').addEventListener('scroll', checkScroll);
            window.addEventListener('scroll', checkScroll);
        }

        function resetPages(n) {
            state.pageCount = n;
            state.pages = [];
            for(let i=0; i<n; i++) {
                let html = TEMPLATES.text;
                if(i===0) html = TEMPLATES.cover;
                if(i===n-1) html = TEMPLATES.hymn;
                state.pages.push({ id: i, html: html });
            }
            render();
            updatePrice();
        }

        function render() {
            const workspace = document.getElementById('workspace');
            const map = document.getElementById('mini-map');
            workspace.innerHTML = '';
            map.innerHTML = '';

            state.pages.forEach((page, i) => {
                // 1. Create Page Card
                const card = document.createElement('div');
                card.className = `page-card font-${state.theme}`;
                card.id = `page-${i}`;
                
                let label = `Page ${i+1}`;
                if(i===0) label = "Front Cover";
                
                card.innerHTML = `
                    <div class="page-label">
                        <span>${label}</span>
                        ${i > 0 ? '<i class="fas fa-grip-lines text-gray-300"></i>' : ''}
                    </div>
                    <div class="layout-trigger" onclick="openLayoutMenu(event, ${i})"><i class="fas fa-th-large text-xs"></i></div>
                    <div class="content-layer" id="content-${i}">
                        ${page.html}
                    </div>
                `;

                // Auto-focus on click
                card.addEventListener('click', () => {
                    document.querySelectorAll('.page-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    updateMiniMap(i);
                });

                // Auto-save on input
                card.addEventListener('input', () => {
                    state.pages[i].html = document.getElementById(`content-${i}`).innerHTML;
                });

                workspace.appendChild(card);

                // 2. Create Mini Map Dot
                const dot = document.createElement('div');
                dot.className = `nav-dot ${i===0?'active':''}`;
                dot.dataset.label = label;
                dot.onclick = () => {
                    document.getElementById(`page-${i}`).scrollIntoView({behavior: 'smooth', block: 'center'});
                };
                map.appendChild(dot);
            });
        }

        function checkScroll() {
            // Simple logic to highlight dot based on scroll position
            // (Omitted for brevity, but would use IntersectionObserver in prod)
        }

        function updateMiniMap(idx) {
            document.querySelectorAll('.nav-dot').forEach((d, i) => {
                if(i===idx) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        // === LAYOUT SWAPPER ===
        let targetPageIdx = 0;
        function openLayoutMenu(e, idx) {
            e.stopPropagation(); // Don't trigger card click
            targetPageIdx = idx;
            const menu = document.getElementById('layout-menu');
            
            // Position near the button
            const rect = e.target.getBoundingClientRect();
            menu.style.top = (rect.top + window.scrollY) + 'px';
            menu.style.right = (window.innerWidth - rect.right + 20) + 'px';
            
            menu.classList.add('open');
            
            // Close on click outside
            document.addEventListener('click', closeLayoutMenu, {once:true});
        }
        
        function closeLayoutMenu() {
             document.getElementById('layout-menu').classList.remove('open');
        }

        function applyLayout(type) {
            state.pages[targetPageIdx].html = TEMPLATES[type];
            document.getElementById(`content-${targetPageIdx}`).innerHTML = TEMPLATES[type];
        }

        // === PHOTO ===
        let uploadTarget = null;
        function upload(el) {
            uploadTarget = el;
            document.getElementById('img-upload').click();
        }
        document.getElementById('img-upload').onchange = (e) => {
            if(e.target.files[0] && uploadTarget) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    uploadTarget.innerHTML = `<img src="${evt.target.result}">`;
                    uploadTarget.style.background = 'transparent';
                    uploadTarget.style.border = 'none';
                    // Trigger save
                    const idx = uploadTarget.closest('.page-card').id.split('-')[1];
                    state.pages[idx].html = document.getElementById(`content-${idx}`).innerHTML;
                    updatePrice();
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        // === PRICING ===
        function addPages() {
            const next = state.pageCount === 4 ? 8 : (state.pageCount === 8 ? 12 : 4);
            if(confirm(`Change to ${next} pages?`)) resetPages(next);
        }

        function updatePrice() {
            let price = 80;
            if(state.pageCount > 4) price += (state.pageCount-4)*10;
            document.getElementById('total-price').innerText = `£${price.toFixed(2)}`;
        }

        function setTheme(font) {
            state.theme = font;
            document.querySelectorAll('.page-card').forEach(c => {
                c.className = `page-card font-${font}`;
            });
        }

        // === PREVIEW ===
        function openPreview() {
            const spine = document.getElementById('book-spine');
            spine.innerHTML = '';
            state.pages.forEach((p, i) => {
                const sheet = document.createElement('div');
                sheet.className = `sheet-3d font-${state.theme}`;
                sheet.id = `sheet-${i}`;
                sheet.style.zIndex = state.pageCount - i;
                sheet.innerHTML = `<div class="w-full h-full p-6 bg-white text-black flex flex-col relative overflow-hidden text-[0.8em]">${p.html}</div>`;
                spine.appendChild(sheet);
            });
            state.previewIdx = 0;
            document.getElementById('preview-overlay').classList.add('open');
        }
        function closePreview() { document.getElementById('preview-overlay').classList.remove('open'); }
        function flipForward() {
            if(state.previewIdx < state.pageCount-1) {
                document.getElementById(`sheet-${state.previewIdx}`).classList.add('flipped');
                state.previewIdx++;
            }
        }
        function flipBack() {
            if(state.previewIdx > 0) {
                state.previewIdx--;
                document.getElementById(`sheet-${state.previewIdx}`).classList.remove('flipped');
            }
        }

        // Init
        init();
    </script>
</body>
</html>
