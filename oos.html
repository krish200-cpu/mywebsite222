<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FuneralMatch Service Creator</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg-app: #080808;
            --bg-panel: #121212;
            --border: #222;
            --gold: #D4AF37;
            --gold-dim: rgba(212, 175, 55, 0.15);
            
            /* Print Dimensions (A5 Ratio) */
            --page-width: 148mm;
            --page-height: 210mm;
            --page-ratio: 0.707; /* 1 / 1.414 */
        }

        /* --- 2. GLOBAL APP STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-app);
            color: white;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* App container */
            display: flex; flex-direction: column;
        }

        /* --- 3. WORKSPACE (The Virtual Desk) --- */
        #workspace {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 40px 20px 140px 20px;
            display: flex; flex-direction: column; align-items: center; gap: 40px;
            scroll-behavior: smooth;
        }

        /* The Page (Screen View) */
        .a5-page {
            width: 100%;
            max-width: 500px;
            aspect-ratio: var(--page-ratio);
            background: white;
            color: black;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* Focus Mode */
        .a5-page.focused {
            box-shadow: 0 0 0 3px var(--gold), 0 30px 80px rgba(0,0,0,0.8);
            transform: scale(1.02);
            z-index: 10;
        }

        /* Page Label (Screen Only) */
        .page-meta {
            position: absolute; top: -25px; left: 0; width: 100%;
            display: flex; justify-content: space-between;
            font-size: 10px; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 1px;
        }

        /* Reorder Handle */
        .drag-handle {
            display: none; /* Hidden unless in sort mode */
            position: absolute; top: 10px; right: 10px;
            width: 32px; height: 32px; background: #eee; border-radius: 50%;
            color: #333; align-items: center; justify-content: center; cursor: grab; z-index: 50;
        }

        /* --- 4. CONTENT STYLING --- */
        .content-area {
            flex: 1; padding: 10%; display: flex; flex-direction: column;
        }

        /* Editables */
        [contenteditable] {
            outline: none; border: 1px dashed transparent; transition: 0.2s; cursor: text;
        }
        [contenteditable]:hover { border-color: rgba(212,175,55,0.3); background: rgba(0,0,0,0.02); }
        [contenteditable]:focus { border-color: var(--gold); background: rgba(212,175,55,0.05); }

        /* Photo Zones */
        .photo-zone {
            background: #f4f4f4; width: 100%; display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative; color: #ccc; transition: 0.2s; cursor: pointer;
        }
        .photo-zone:hover { opacity: 0.8; box-shadow: inset 0 0 0 2px var(--gold); }
        .photo-zone img { width: 100%; height: 100%; object-fit: cover; }

        /* Typography Classes */
        .font-classic { font-family: 'Bodoni Moda', serif; }
        .font-modern { font-family: 'Inter', sans-serif; }
        .font-formal { font-family: 'Cinzel', serif; }
        .font-soft { font-family: 'Cormorant Garamond', serif; }

        /* --- 5. UI COMPONENTS (Dock & Header) --- */
        .app-bar {
            height: 60px; background: rgba(10,10,10,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50; flex-shrink: 0;
        }

        .dock {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20,20,20,0.95); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 99px;
            padding: 8px 12px; display: flex; gap: 8px; z-index: 60;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .dock-btn {
            height: 48px; padding: 0 20px; border-radius: 99px;
            background: transparent; color: #aaa; border: 1px solid transparent;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s;
        }
        .dock-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .dock-btn.active { color: var(--gold); background: var(--gold-dim); border-color: rgba(197,160,89,0.3); }
        
        .dock-btn.primary { background: var(--gold); color: black; box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        .dock-btn.primary:hover { background: white; }

        /* --- 6. MENUS & MODALS --- */
        .sheet-menu {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1a1a1a; border-radius: 24px 24px 0 0;
            padding: 24px; transform: translateY(110%); transition: transform 0.3s ease;
            z-index: 70; border-top: 1px solid #333; max-height: 80vh; overflow-y: auto;
        }
        .sheet-menu.open { transform: translateY(0); }

        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .menu-item {
            background: #252525; padding: 16px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .menu-item:hover { border-color: var(--gold); background: #2a2a2a; }
        .menu-item i { font-size: 20px; color: #888; }
        .menu-item span { font-size: 11px; font-weight: 600; color: white; }

        /* --- 7. SORT MODE STYLES --- */
        body.sorting .drag-handle { display: flex; }
        body.sorting .a5-page { transform: scale(0.95); opacity: 0.8; }
        body.sorting .a5-page.focused { transform: scale(1); opacity: 1; border: 2px solid var(--gold); }

        /* --- 8. PRINT STYLES (The Critical Part) --- */
        @media print {
            body { background: white; display: block; height: auto; overflow: visible; }
            .app-bar, .dock, .sheet-menu, .page-meta, .drag-handle { display: none !important; }
            #workspace { padding: 0; margin: 0; display: block; overflow: visible; }
            
            .a5-page {
                box-shadow: none; margin: 0; width: 100%; max-width: 100%;
                break-after: page; /* Force page break */
                page-break-after: always;
                border: none;
            }
            
            [contenteditable] { border: none !important; }
            
            /* Print Settings */
            @page { size: A5; margin: 0; }
        }

    </style>
</head>
<body>

    <div class="app-bar">
        <div>
            <span class="text-[9px] uppercase font-bold text-[#D4AF37] tracking-widest block">FuneralMatch</span>
            <span class="text-xs font-bold text-white">Order of Service</span>
        </div>
        <div class="flex items-center gap-3">
            <span id="page-counter" class="text-xs font-bold text-gray-500">4 Pages</span>
            <div class="h-4 w-px bg-white/10"></div>
            <button onclick="saveProject()" class="text-xs font-bold text-[#D4AF37] hover:text-white transition-colors">
                <i class="fas fa-save mr-1"></i> Save
            </button>
        </div>
    </div>

    <div id="workspace">
        </div>

    <div class="dock">
        <button class="dock-btn" onclick="openMenu('add')">
            <i class="fas fa-plus"></i> <span class="hidden sm:inline">Add Page</span>
        </button>
        <button class="dock-btn" onclick="openMenu('style')">
            <i class="fas fa-font"></i> <span class="hidden sm:inline">Style</span>
        </button>
        <button class="dock-btn" id="btn-sort" onclick="toggleSort()">
            <i class="fas fa-sort"></i> <span class="hidden sm:inline">Sort</span>
        </button>
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <button class="dock-btn primary" onclick="printBooklet()">
            <i class="fas fa-print"></i> <span>Print / PDF</span>
        </button>
    </div>

    <div id="menu-add" class="sheet-menu">
        <div class="flex justify-between items-center mb-6">
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Add Content</span>
            <button onclick="closeMenus()" class="text-gray-500"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="addPage('text')">
                <i class="fas fa-align-left"></i> <span>Text / Reading</span>
            </div>
            <div class="menu-item" onclick="addPage('photo')">
                <i class="fas fa-image"></i> <span>Full Photo</span>
            </div>
            <div class="menu-item" onclick="addPage('hymn')">
                <i class="fas fa-music"></i> <span>Hymn</span>
            </div>
            <div class="menu-item" onclick="addPage('collage')">
                <i class="fas fa-images"></i> <span>Photo Collage</span>
            </div>
        </div>
    </div>

    <div id="menu-style" class="sheet-menu">
        <div class="flex justify-between items-center mb-6">
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Typography</span>
            <button onclick="closeMenus()" class="text-gray-500"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="applyFont('classic')">
                <span class="font-serif text-xl">Aa</span> <span>Bodoni (Classic)</span>
            </div>
            <div class="menu-item" onclick="applyFont('modern')">
                <span class="font-sans font-bold text-xl">Aa</span> <span>Inter (Modern)</span>
            </div>
            <div class="menu-item" onclick="applyFont('formal')">
                <span style="font-family: 'Cinzel', serif" class="text-xl">Aa</span> <span>Cinzel (Formal)</span>
            </div>
            <div class="menu-item" onclick="applyFont('soft')">
                <span style="font-family: 'Cormorant Garamond', serif" class="text-xl italic">Aa</span> <span>Cormorant (Soft)</span>
            </div>
        </div>
    </div>

    <input type="file" id="img-upload" class="hidden" accept="image/*">

    <script>
        // === 1. DATA STATE & TEMPLATES ===
        const state = {
            pages: [],
            font: 'classic',
            sorting: false
        };

        const TEMPLATES = {
            cover: `
                <div class="h-full flex flex-col items-center justify-center text-center p-8">
                    <div class="mb-8 text-xs uppercase tracking-widest opacity-60" contenteditable="true">In Loving Memory of</div>
                    <div class="photo-zone rounded-full w-40 h-40 mb-8 border-4 border-double border-gray-100" onclick="triggerUpload(this)">
                        <i class="fas fa-camera text-2xl opacity-20"></i>
                    </div>
                    <div class="text-4xl mb-4 font-bold leading-tight" contenteditable="true">Name<br>Here</div>
                    <div class="text-sm opacity-60 italic mb-8" contenteditable="true">1950 â€” 2026</div>
                    <div class="mt-auto text-[10px] uppercase font-bold opacity-40" contenteditable="true">St Mary's Church</div>
                </div>`,
            
            text: `
                <div class="h-full p-10 flex flex-col">
                    <div class="text-lg font-bold mb-6 border-b border-gray-100 pb-2 text-[#D4AF37]" contenteditable="true">Reading</div>
                    <div class="text-sm leading-loose opacity-80 whitespace-pre-wrap flex-1" contenteditable="true">
Tap here to type content.
You can add poems, eulogies, or details about the service here.
                    </div>
                </div>`,
            
            photo: `
                <div class="h-full flex flex-col">
                    <div class="photo-zone w-full h-2/3 mb-6 bg-gray-50" onclick="triggerUpload(this)">
                        <div class="flex flex-col items-center"><i class="fas fa-image opacity-30 mb-2"></i><span class="text-[9px] uppercase font-bold opacity-30">Add Photo</span></div>
                    </div>
                    <div class="px-8 text-center">
                        <div class="text-lg font-bold mb-2" contenteditable="true">Caption</div>
                        <div class="text-xs opacity-60" contenteditable="true">Add a description...</div>
                    </div>
                </div>`,
            
            hymn: `
                <div class="h-full flex flex-col items-center justify-start pt-12 text-center px-8">
                    <div class="text-[10px] uppercase font-bold opacity-40 mb-4 tracking-widest" contenteditable="true">Hymn</div>
                    <div class="text-2xl italic mb-8" contenteditable="true">Abide With Me</div>
                    <div class="text-xs italic opacity-70 leading-loose" contenteditable="true">
Abide with me;<br>fast falls the eventide;<br>The darkness deepens;<br>Lord with me abide.<br>When other helpers fail<br>and comforts flee,<br>Help of the helpless,<br>O abide with me.
                    </div>
                </div>`
        };

        // === 2. INITIALIZATION ===
        function init() {
            // Check LocalStorage
            const saved = localStorage.getItem('funeralMatchProject');
            if (saved) {
                const data = JSON.parse(saved);
                state.pages = data.pages;
                state.font = data.font;
            } else {
                // Default Start
                state.pages = [
                    { id: Date.now(), html: TEMPLATES.cover, type: 'cover' },
                    { id: Date.now()+1, html: TEMPLATES.text, type: 'text' },
                    { id: Date.now()+2, html: TEMPLATES.hymn, type: 'hymn' },
                    { id: Date.now()+3, html: `
                        <div class="h-full flex flex-col items-center justify-end pb-12 text-center p-8">
                            <div class="photo-zone w-20 h-20 mb-4 rounded bg-gray-50 mx-auto" onclick="triggerUpload(this)"><i class="fas fa-plus opacity-20"></i></div>
                            <div class="font-bold mb-2 text-sm" contenteditable="true">Donations</div>
                            <div class="text-xs opacity-60" contenteditable="true">To The Hospice Charity.</div>
                        </div>`, type: 'back' }
                ];
            }
            render();
        }

        // === 3. RENDER ENGINE ===
        function render() {
            const container = document.getElementById('workspace');
            container.innerHTML = ''; // Clear

            state.pages.forEach((page, index) => {
                const el = document.createElement('div');
                el.className = `a5-page font-${state.font}`;
                el.id = `page-${index}`;
                
                // Meta Label
                let label = `Page ${index+1}`;
                if (index === 0) label = "Front Cover";
                if (index === state.pages.length - 1) label = "Back Cover";

                el.innerHTML = `
                    <div class="page-meta">
                        <span>${label}</span>
                        ${state.sorting ? '<i class="fas fa-bars"></i>' : ''}
                    </div>
                    <div class="drag-handle" onclick="movePage(${index})"><i class="fas fa-arrow-down"></i></div>
                    <div class="content-area" id="content-${index}">
                        ${page.html}
                    </div>
                `;

                // Focus Events
                el.addEventListener('click', () => {
                    if (state.sorting) return;
                    document.querySelectorAll('.a5-page').forEach(p => p.classList.remove('focused'));
                    el.classList.add('focused');
                });

                // Auto-Save Content Changes
                el.addEventListener('input', () => {
                    state.pages[index].html = document.getElementById(`content-${index}`).innerHTML;
                    saveProject(false); // Silent save
                });

                container.appendChild(el);
            });

            // Update Counters
            document.getElementById('page-counter').innerText = `${state.pages.length} Pages`;
            if (state.pages.length % 4 !== 0) {
                document.getElementById('page-counter').style.color = '#ef4444'; // Red warning
                document.getElementById('page-counter').innerText += " (Add " + (4 - (state.pages.length % 4)) + ")";
            } else {
                document.getElementById('page-counter').style.color = '#6b7280';
            }
        }

        // === 4. PAGE ACTIONS ===
        function addPage(type) {
            state.pages.splice(state.pages.length - 1, 0, { id: Date.now(), html: TEMPLATES[type], type: type });
            render();
            closeMenus();
            saveProject();
        }

        function toggleSort() {
            state.sorting = !state.sorting;
            const btn = document.getElementById('btn-sort');
            
            if (state.sorting) {
                document.body.classList.add('sorting');
                btn.classList.add('active');
            } else {
                document.body.classList.remove('sorting');
                btn.classList.remove('active');
            }
            render();
        }

        function movePage(index) {
            // Simple swap down logic for mobile
            if (index < state.pages.length - 1) {
                const temp = state.pages[index];
                state.pages[index] = state.pages[index+1];
                state.pages[index+1] = temp;
                render();
                saveProject();
            }
        }

        function applyFont(fontName) {
            state.font = fontName;
            render();
            closeMenus();
            saveProject();
        }

        // === 5. IMAGE UPLOAD ===
        let uploadTarget = null;
        function triggerUpload(el) {
            uploadTarget = el;
            document.getElementById('img-upload').click();
        }

        document.getElementById('img-upload').onchange = (e) => {
            if (e.target.files[0] && uploadTarget) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    uploadTarget.innerHTML = `<img src="${evt.target.result}">`;
                    uploadTarget.style.background = 'transparent';
                    // Trigger save
                    const pageIndex = uploadTarget.closest('.a5-page').id.split('-')[1];
                    state.pages[pageIndex].html = document.getElementById(`content-${pageIndex}`).innerHTML;
                    saveProject();
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        // === 6. SYSTEM ===
        function openMenu(id) {
            closeMenus();
            document.getElementById(`menu-${id}`).classList.add('open');
        }

        function closeMenus() {
            document.querySelectorAll('.sheet-menu').forEach(m => m.classList.remove('open'));
        }

        function saveProject(notify = true) {
            localStorage.setItem('funeralMatchProject', JSON.stringify(state));
            if (notify) {
                const btn = document.querySelector('.fa-save').parentNode;
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Saved';
                setTimeout(() => btn.innerHTML = original, 2000);
            }
        }

        function printBooklet() {
            window.print();
        }

        // Boot
        init();

    </script>
</body>
</html>
