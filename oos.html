<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Order of Service Designer | FuneralMatch</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,500&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        /* =========================================
         * 1. DESIGN SYSTEM TOKENS
         * ========================================= */
        :root {
            /* Palette */
            --bg-deep: #050505;
            --bg-panel: #121212;
            --surface-glass: rgba(20, 20, 20, 0.85);
            --gold-primary: #D4AF37;
            --gold-dim: #8A7326;
            --text-main: #F2F2F2;
            --text-mute: #888888;
            
            /* Shapes */
            --radius-xl: 32px;
            --radius-md: 16px;
            --radius-pill: 999px;
            
            /* Motion */
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
            --shadow-float: 0 20px 50px -10px rgba(0,0,0,0.6);
            --shadow-gold: 0 0 0 2px rgba(212, 175, 55, 0.5);
            
            /* A5 Dimensions (Screen Scaled) */
            --page-width: 148mm;
            --page-height: 210mm;
            --scale-ratio: 0.8; /* Visual scaling for desktop */
        }

        /* =========================================
         * 2. GLOBAL RESET & UTILITIES
         * ========================================= */
        html { background: var(--bg-deep); height: 100%; }
        body {
            font-family: 'Inter', sans-serif; color: var(--text-main);
            min-height: 100vh; margin: 0; overflow-x: hidden;
            display: flex; flex-direction: column;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 60%);
        }

        /* Scrollbar Hide */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        /* =========================================
         * 3. FLOATING INTERFACE
         * ========================================= */
        .header-island {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 680px; height: 72px;
            background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-pill);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px 0 32px; z-index: 100;
            box-shadow: 0 24px 48px -12px rgba(0,0,0,0.5);
            transition: all 0.3s var(--ease-out);
        }

        .brand-block { display: flex; flex-direction: column; }
        .brand-logo { font-family: 'Bodoni Moda', serif; font-weight: 700; letter-spacing: -0.02em; font-size: 18px; color: white; }
        .brand-sub { font-size: 9px; text-transform: uppercase; color: var(--gold-primary); letter-spacing: 0.2em; font-weight: 700; margin-top: 2px; }

        .action-group { display: flex; gap: 8px; }
        
        .header-btn {
            height: 48px; padding: 0 20px; border-radius: var(--radius-pill);
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; font-weight: 600; color: var(--text-mute);
            background: rgba(255,255,255,0.03); border: 1px solid transparent;
            cursor: pointer; transition: 0.2s;
        }
        .header-btn:hover { background: rgba(255,255,255,0.08); color: white; }
        .header-btn.primary {
            background: var(--gold-primary); color: #000;
            font-weight: 700; box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
        }
        .header-btn.primary:hover { background: #E5C14D; transform: translateY(-1px); }

        /* =========================================
         * 4. CANVAS AREA (The Desk)
         * ========================================= */
        .workspace {
            flex: 1; padding: 140px 20px 180px 20px;
            display: flex; flex-direction: column; align-items: center; gap: 60px;
            perspective: 1000px;
        }

        /* The Page (Physical Object) */
        .page-sheet {
            position: relative;
            width: 100%; max-width: 460px; /* A5 Scaled */
            aspect-ratio: 148 / 210;
            background: #FAFAFA; color: #1a1a1a;
            border-radius: 4px; /* Crisp paper corners */
            box-shadow: var(--shadow-float);
            transform-origin: center top;
            transition: transform 0.4s var(--ease-out), box-shadow 0.4s var(--ease-out);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .page-sheet:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 30px 60px -15px rgba(0,0,0,0.5); }
        .page-sheet.active { ring: 3px solid var(--gold-primary); ring-offset: 4px; ring-offset-color: var(--bg-deep); }

        /* Page Indicators */
        .page-meta {
            position: absolute; top: 0; left: -40px; bottom: 0; width: 30px;
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 0.4; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;
            writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);
        }

        /* Delete Button */
        .delete-page-btn {
            position: absolute; top: 16px; right: -50px;
            width: 36px; height: 36px; border-radius: 50%;
            background: #2a1a1a; color: #ff4444; border: 1px solid #442222;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s; cursor: pointer;
        }
        .workspace:hover .delete-page-btn { opacity: 1; right: -60px; }

        /* =========================================
         * 5. EDITABLE CONTENT
         * ========================================= */
        .editable-area {
            outline: none; border: 1px dashed transparent; border-radius: 4px;
            transition: 0.2s; cursor: text; min-height: 1.2em;
        }
        .editable-area:hover { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.1); }
        .editable-area:focus { background: rgba(212, 175, 55, 0.05); border-color: var(--gold-primary); }
        
        /* Placeholder logic */
        .editable-area:empty:before {
            content: attr(data-placeholder);
            color: #aaa; font-style: italic; pointer-events: none;
        }

        /* Image Handling */
        .img-container {
            width: 100%; height: 100%; background: #f0f0f0;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; transition: 0.3s; position: relative;
        }
        .img-container:hover { opacity: 0.9; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }
        .img-placeholder { display: flex; flex-direction: column; align-items: center; gap: 8px; color: #999; }

        /* =========================================
         * 6. BOTTOM DOCK (Toolbar)
         * ========================================= */
        .dock-container {
            position: fixed; bottom: 32px; left: 0; right: 0;
            display: flex; justify-content: center; z-index: 90;
            pointer-events: none;
        }

        .dock-bar {
            pointer-events: auto;
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-pill);
            padding: 6px; display: flex; gap: 6px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .tool-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: transparent; border: none; color: #888;
            font-size: 18px; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .tool-btn span { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0; transform: translateY(5px); transition: 0.2s; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; width: 60px; border-radius: 20px; }
        .tool-btn:hover span { opacity: 1; transform: translateY(0); }
        
        .tool-separator { width: 1px; height: 24px; background: rgba(255,255,255,0.1); margin: auto 4px; }

        /* =========================================
         * 7. DRAWERS (Context Menus)
         * ========================================= */
        .drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 150; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .drawer-overlay.active { opacity: 1; pointer-events: auto; }

        .drawer-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #181818; border-top: 1px solid #333;
            border-radius: 32px 32px 0 0;
            padding: 32px; padding-bottom: 60px; z-index: 200;
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.3, 1.2, 0.6, 1);
            max-width: 800px; margin: 0 auto;
        }
        .drawer-panel.open { transform: translateY(0); }

        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .drawer-title { font-family: 'Bodoni Moda', serif; font-size: 24px; color: white; }

        /* Template Grid */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; }
        
        .template-option {
            background: #222; border: 1px solid #333; border-radius: 16px;
            padding: 20px; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 12px; text-align: center;
        }
        .template-option:hover { background: #2a2a2a; border-color: #555; transform: translateY(-2px); }
        .template-option i { font-size: 24px; color: var(--gold-primary); opacity: 0.8; }
        .template-label { font-size: 11px; font-weight: 600; color: #ccc; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Style Controls */
        .style-group { margin-bottom: 32px; }
        .style-label { font-size: 10px; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 12px; display: block; }
        
        .swatch-row { display: flex; gap: 12px; }
        .color-swatch {
            width: 48px; height: 48px; border-radius: 12px; cursor: pointer;
            border: 2px solid transparent; transition: 0.2s; position: relative;
        }
        .color-swatch.active { border-color: var(--gold-primary); transform: scale(1.1); }
        .color-swatch.cream { background: #F9F7F2; }
        .color-swatch.white { background: #FFFFFF; }
        .color-swatch.stone { background: #EBEBEB; }
        .color-swatch.navy { background: #1a2a3a; }

        /* =========================================
         * 8. PRINT & EXPORT STYLES
         * ========================================= */
        @media print {
            body { background: white; margin: 0; display: block; }
            .header-island, .dock-container, .delete-page-btn, .page-meta, .drawer-overlay { display: none !important; }
            .workspace { padding: 0; margin: 0; display: block; }
            .page-sheet {
                box-shadow: none; border-radius: 0; margin: 0; width: 100%; max-width: 100%;
                break-after: page; page-break-after: always;
                border: none; aspect-ratio: auto; height: 100vh;
            }
            .editable-area { border: none !important; }
            .editable-area:empty:before { content: none; }
            @page { size: A5; margin: 0; }
        }

    </style>
</head>
<body>

    <header class="header-island">
        <div class="brand-block">
            <span class="brand-logo">FuneralMatch</span>
            <span class="brand-sub">Order of Service</span>
        </div>
        
        <div class="action-group">
            <button class="header-btn" onclick="saveProject()">
                <i class="fas fa-cloud-upload-alt"></i> <span class="hidden sm:inline">Save</span>
            </button>
            <button class="header-btn primary" onclick="exportPDF()">
                <span>Finalise PDF</span> <i class="fas fa-chevron-right text-xs"></i>
            </button>
        </div>
    </header>

    <div id="workspace" class="workspace">
        </div>

    <div class="dock-container">
        <div class="dock-bar">
            <button class="tool-btn" onclick="openDrawer('add')">
                <i class="fas fa-plus"></i>
                <span>Add Page</span>
            </button>
            <div class="tool-separator"></div>
            <button class="tool-btn" onclick="openDrawer('style')">
                <i class="fas fa-palette"></i>
                <span>Theme</span>
            </button>
            <button class="tool-btn" onclick="openDrawer('type')">
                <i class="fas fa-font"></i>
                <span>Type</span>
            </button>
            <div class="tool-separator"></div>
            <button class="tool-btn" onclick="togglePreviewMode()">
                <i class="fas fa-eye"></i>
                <span>Preview</span>
            </button>
        </div>
    </div>

    <div id="drawer-overlay" class="drawer-overlay" onclick="closeDrawers()"></div>

    <div id="drawer-add" class="drawer-panel">
        <div class="drawer-header">
            <span class="drawer-title">Select Layout</span>
            <button onclick="closeDrawers()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="template-grid">
            <div class="template-option" onclick="addPage('cover')">
                <i class="far fa-id-card"></i> <span class="template-label">Cover</span>
            </div>
            <div class="template-option" onclick="addPage('hymn')">
                <i class="fas fa-music"></i> <span class="template-label">Hymn</span>
            </div>
            <div class="template-option" onclick="addPage('reading')">
                <i class="fas fa-book-open"></i> <span class="template-label">Reading</span>
            </div>
            <div class="template-option" onclick="addPage('photo')">
                <i class="far fa-image"></i> <span class="template-label">Photo Full</span>
            </div>
            <div class="template-option" onclick="addPage('collage')">
                <i class="fas fa-th-large"></i> <span class="template-label">Collage</span>
            </div>
            <div class="template-option" onclick="addPage('timeline')">
                <i class="fas fa-stream"></i> <span class="template-label">Timeline</span>
            </div>
        </div>
    </div>

    <div id="drawer-style" class="drawer-panel">
        <div class="drawer-header">
            <span class="drawer-title">Paper & Theme</span>
            <button onclick="closeDrawers()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="style-group">
            <span class="style-label">Paper Stock</span>
            <div class="swatch-row">
                <div class="color-swatch cream active" onclick="setTheme('cream')"></div>
                <div class="color-swatch white" onclick="setTheme('white')"></div>
                <div class="color-swatch stone" onclick="setTheme('stone')"></div>
            </div>
        </div>
    </div>

    <div id="drawer-type" class="drawer-panel">
        <div class="drawer-header">
            <span class="drawer-title">Typography</span>
            <button onclick="closeDrawers()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="template-grid">
            <div class="template-option" onclick="setFont('bodoni')">
                <span style="font-family: 'Bodoni Moda', serif; font-size: 24px;">Ag</span>
                <span class="template-label">Classic</span>
            </div>
            <div class="template-option" onclick="setFont('inter')">
                <span style="font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 600;">Ag</span>
                <span class="template-label">Modern</span>
            </div>
            <div class="template-option" onclick="setFont('cinzel')">
                <span style="font-family: 'Cinzel', serif; font-size: 20px;">Ag</span>
                <span class="template-label">Formal</span>
            </div>
            <div class="template-option" onclick="setFont('cormorant')">
                <span style="font-family: 'Cormorant Garamond', serif; font-size: 26px; font-style: italic;">Ag</span>
                <span class="template-label">Soft</span>
            </div>
        </div>
    </div>

    <input type="file" id="img-input" class="hidden" accept="image/*">

    <script>
        // === STATE MANAGEMENT ===
        const state = {
            pages: [],
            theme: 'cream',
            font: 'bodoni',
            projectID: 'OOS_' + Date.now()
        };

        // === HTML TEMPLATES ===
        const TEMPLATES = {
            cover: `
                <div class="flex-1 flex flex-col items-center justify-center text-center p-8">
                    <div class="editable-area text-[10px] uppercase tracking-[0.25em] font-bold text-gray-400 mb-8" contenteditable="true" data-placeholder="SUBTITLE">IN LOVING MEMORY OF</div>
                    
                    <div class="img-container w-48 h-48 rounded-full shadow-xl mb-10 border-4 border-white" onclick="triggerUpload(this)">
                        <div class="img-placeholder"><i class="fas fa-camera"></i><span class="text-[9px] font-bold uppercase">Add Photo</span></div>
                    </div>
                    
                    <div class="editable-area text-5xl font-bold mb-4 leading-tight text-gray-900" contenteditable="true" data-placeholder="Full Name">Name Here</div>
                    
                    <div class="editable-area text-lg italic text-gray-500 mb-12" contenteditable="true" data-placeholder="Dates">1950 — 2026</div>
                    
                    <div class="mt-auto border-t border-gray-200 pt-6 w-full max-w-[200px]">
                        <div class="editable-area text-[10px] font-bold uppercase tracking-widest text-gray-400" contenteditable="true" data-placeholder="Location">St Mary's Church</div>
                        <div class="editable-area text-[10px] font-bold uppercase tracking-widest text-gray-400 mt-1" contenteditable="true" data-placeholder="Date & Time">24th Jan • 11:00 AM</div>
                    </div>
                </div>`,
            
            hymn: `
                <div class="flex-1 flex flex-col items-center pt-16 px-10 text-center">
                    <div class="editable-area text-[10px] uppercase tracking-[0.2em] font-bold text-[#D4AF37] mb-6" contenteditable="true">HYMN</div>
                    <div class="editable-area text-2xl font-bold text-gray-800 mb-8" contenteditable="true">Abide With Me</div>
                    <div class="editable-area text-sm leading-loose text-gray-600 whitespace-pre-wrap font-medium" contenteditable="true">
Abide with me; fast falls the eventide;
The darkness deepens; Lord with me abide.
When other helpers fail and comforts flee,
Help of the helpless, O abide with me.

Swift to its close ebbs out life’s little day;
Earth’s joys grow dim; its glories pass away;
Change and decay in all around I see;
O Thou who changest not, abide with me.
                    </div>
                </div>`,

            reading: `
                <div class="flex-1 flex flex-col justify-center px-12 text-left">
                    <div class="editable-area text-xl font-bold text-[#D4AF37] mb-6 border-b border-gray-200 pb-4" contenteditable="true">Reading</div>
                    <div class="editable-area text-base leading-relaxed text-gray-700 whitespace-pre-wrap" contenteditable="true">
"Death is nothing at all.
I have only slipped away into the next room.
I am I and you are you.
Whatever we were to each other, that we still are.

Call me by my old familiar name.
Speak to me in the easy way which you always used.
Put no difference in your tone."
                    </div>
                    <div class="editable-area text-xs font-bold uppercase tracking-widest text-gray-400 mt-6" contenteditable="true">— Henry Scott Holland</div>
                </div>`,

            photo: `
                <div class="flex-1 flex flex-col">
                    <div class="img-container w-full h-[70%] bg-gray-100" onclick="triggerUpload(this)">
                        <div class="img-placeholder"><i class="far fa-image text-3xl"></i><span class="text-[10px] font-bold uppercase mt-2">Add Full Image</span></div>
                    </div>
                    <div class="flex-1 flex flex-col justify-center items-center text-center p-8 bg-white">
                        <div class="editable-area text-lg font-bold mb-2" contenteditable="true">A Life Well Lived</div>
                        <div class="editable-area text-xs text-gray-400 max-w-[200px]" contenteditable="true">Capture a caption here...</div>
                    </div>
                </div>`
        };

        // === INITIALIZATION ===
        function init() {
            // Check for saved project
            const saved = localStorage.getItem('fm_oos_v1');
            if (saved) {
                const data = JSON.parse(saved);
                state.pages = data.pages;
                state.theme = data.theme;
                state.font = data.font;
                restorePages();
            } else {
                // Default setup
                addPage('cover', false);
                addPage('hymn', false);
                addPage('reading', false);
                addPage('photo', false);
            }
            applyTheme();
            applyFont();
        }

        // === CORE FUNCTIONS ===
        function addPage(type, save = true) {
            const id = Date.now();
            const html = TEMPLATES[type];
            
            const pageObj = { id, type, html };
            state.pages.push(pageObj);
            
            renderPage(pageObj, state.pages.length - 1);
            
            if(save) {
                saveProject();
                closeDrawers();
                // Smooth scroll to new page
                setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
            }
        }

        function renderPage(pageObj, index) {
            const container = document.getElementById('workspace');
            const sheet = document.createElement('div');
            
            sheet.className = 'page-sheet';
            sheet.id = `page-${pageObj.id}`;
            sheet.innerHTML = `
                <div class="page-meta">Page ${index + 1}</div>
                <button class="delete-page-btn" onclick="removePage(${index})"><i class="fas fa-trash"></i></button>
                ${pageObj.html}
            `;

            // Interaction logic
            sheet.addEventListener('click', () => {
                document.querySelectorAll('.page-sheet').forEach(p => p.classList.remove('active'));
                sheet.classList.add('active');
            });

            // Content update listener
            sheet.addEventListener('input', () => {
                // Debounce save could go here
            });

            container.appendChild(sheet);
            applyThemeToElement(sheet);
            applyFontToElement(sheet);
        }

        function restorePages() {
            const container = document.getElementById('workspace');
            container.innerHTML = '';
            state.pages.forEach((page, index) => renderPage(page, index));
        }

        function removePage(index) {
            if(confirm("Are you sure you want to delete this page?")) {
                state.pages.splice(index, 1);
                document.getElementById('workspace').innerHTML = '';
                state.pages.forEach((p, i) => renderPage(p, i));
                saveProject();
            }
        }

        // === STYLING ENGINE ===
        function setTheme(theme) {
            state.theme = theme;
            applyTheme();
            saveProject();
        }

        function applyTheme() {
            const sheets = document.querySelectorAll('.page-sheet');
            const colors = {
                'cream': '#F9F7F2',
                'white': '#FFFFFF',
                'stone': '#EBEBEB'
            };
            
            sheets.forEach(sheet => {
                sheet.style.backgroundColor = colors[state.theme];
            });

            // Update UI active states
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
            document.querySelector(`.color-swatch.${state.theme}`)?.classList.add('active');
        }

        function applyThemeToElement(el) {
            const colors = { 'cream': '#F9F7F2', 'white': '#FFFFFF', 'stone': '#EBEBEB' };
            el.style.backgroundColor = colors[state.theme];
        }

        function setFont(font) {
            state.font = font;
            applyFont();
            saveProject();
        }

        function applyFont() {
            const sheets = document.querySelectorAll('.page-sheet');
            const fonts = {
                'bodoni': "'Bodoni Moda', serif",
                'inter': "'Inter', sans-serif",
                'cinzel': "'Cinzel', serif",
                'cormorant': "'Cormorant Garamond', serif"
            };
            
            sheets.forEach(sheet => {
                sheet.style.fontFamily = fonts[state.font];
            });
        }

        function applyFontToElement(el) {
            const fonts = {
                'bodoni': "'Bodoni Moda', serif",
                'inter': "'Inter', sans-serif",
                'cinzel': "'Cinzel', serif",
                'cormorant': "'Cormorant Garamond', serif"
            };
            el.style.fontFamily = fonts[state.font];
        }

        // === IMAGE UPLOAD ===
        let currentImgTarget = null;
        
        function triggerUpload(el) {
            currentImgTarget = el;
            document.getElementById('img-input').click();
        }

        document.getElementById('img-input').onchange = (e) => {
            if(e.target.files && e.target.files[0] && currentImgTarget) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    currentImgTarget.innerHTML = `<img src="${evt.target.result}" />`;
                    saveProject(); // Save state with image (base64)
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        // === PERSISTENCE & EXPORT ===
        function saveProject() {
            // Scrape current HTML state to update state object
            const pageElements = document.querySelectorAll('.page-sheet');
            pageElements.forEach((el, index) => {
                // Remove UI meta elements before saving content
                const clone = el.cloneNode(true);
                clone.querySelector('.page-meta')?.remove();
                clone.querySelector('.delete-page-btn')?.remove();
                state.pages[index].html = clone.innerHTML;
            });

            localStorage.setItem('fm_oos_v1', JSON.stringify(state));
            
            // Visual feedback
            const saveBtn = document.querySelector('.header-btn i.fa-cloud-upload-alt');
            saveBtn.className = 'fas fa-check text-green-400';
            setTimeout(() => saveBtn.className = 'fas fa-cloud-upload-alt', 1000);
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a5'); // A5 size
            
            const pages = document.querySelectorAll('.page-sheet');
            const overlay = document.createElement('div');
            
            // Visual loading state
            const btn = document.querySelector('.header-btn.primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Generating...';

            for (let i = 0; i < pages.length; i++) {
                if (i > 0) doc.addPage();
                
                // Use html2canvas
                const canvas = await html2canvas(pages[i], {
                    scale: 2, // High res
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                doc.addImage(imgData, 'JPEG', 0, 0, 148, 210); // A5 dimensions
            }

            doc.save('Order_of_Service_FuneralMatch.pdf');
            
            // Reset button
            btn.innerHTML = originalText;
        }

        // === DRAWER LOGIC ===
        function openDrawer(id) {
            closeDrawers();
            document.getElementById('drawer-overlay').classList.add('active');
            document.getElementById(`drawer-${id}`).classList.add('open');
        }

        function closeDrawers() {
            document.getElementById('drawer-overlay').classList.remove('active');
            document.querySelectorAll('.drawer-panel').forEach(d => d.classList.remove('open'));
        }

        // Initialize App
        init();

    </script>
</body>
</html>
