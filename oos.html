<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Booklet Designer | FuneralMatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #C5A059; --dark: #121212; --panel: #1E1E1E; }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- UI COMPONENTS --- */
        .btn-action { background: var(--gold); color: black; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; padding: 10px 20px; border-radius: 6px; transition: 0.2s; }
        .btn-action:hover { background: white; }
        
        .layout-btn { border: 1px solid #333; background: #222; padding: 8px; border-radius: 4px; cursor: pointer; text-align: center; font-size: 0.65rem; color: #888; transition: 0.2s; }
        .layout-btn:hover { border-color: var(--gold); color: white; }
        .layout-btn.active { background: var(--gold); color: black; border-color: var(--gold); }

        /* --- THE SPREAD (BOOKLET) --- */
        /* A landscape container holding two A5 pages */
        .spread-container { 
            display: flex; 
            width: 100%; 
            max-width: 900px; 
            aspect-ratio: 1.414 / 1; /* A4 Landscape ratio */
            background: #fff; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            margin: auto;
            color: black;
            position: relative;
        }
        
        .page-a5 { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .page-left { border-right: 1px solid #eee; }
        .page-right { border-left: 1px solid #eee; }
        
        /* Page Overlays for Editing */
        .edit-overlay { 
            position: absolute; inset: 0; 
            background: rgba(0,0,0,0.02); 
            opacity: 0; transition: 0.2s; 
            display: flex; flex-direction: column; justify-content: center; items-center; gap: 10px;
            pointer-events: none;
        }
        .page-a5:hover .edit-overlay { opacity: 1; }
        
        /* Typography Themes */
        .font-classic h1, .font-classic h2 { font-family: 'Bodoni Moda', serif; }
        .font-modern h1, .font-modern h2 { font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.1em; }
        .font-script h1, .font-script h2 { font-family: 'Playfair Display', serif; font-style: italic; }

        /* Helpers */
        .photo-slot { background: #f0f0f0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #ccc; cursor: pointer; overflow: hidden; position: relative; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot:hover { background: #e0e0e0; }
        
        .editable-text { border: 1px dashed transparent; min-height: 1.5em; cursor: text; }
        .editable-text:hover { border-color: var(--gold); background: rgba(197, 160, 89, 0.1); }
        .editable-text:focus { outline: none; border-color: var(--gold); background: white; }

        /* Nav Dots */
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background: #333; cursor: pointer; transition: 0.2s; }
        .nav-dot.active { background: var(--gold); transform: scale(1.3); }
    </style>
</head>
<body>

    <div class="h-16 bg-panel border-b border-white/10 flex items-center justify-between px-6 z-20">
        
        <div class="flex items-center gap-6">
            <div>
                <label class="text-[0.6rem] uppercase font-bold text-gray-500 block mb-1">Booklet Size</label>
                <select id="pageCountSelect" onchange="updatePageCount(this.value)" class="bg-black border border-white/20 text-white text-xs rounded px-2 py-1">
                    <option value="4">4 Pages (Standard)</option>
                    <option value="8">8 Pages</option>
                    <option value="12">12 Pages</option>
                    <option value="16">16 Pages (Max)</option>
                </select>
            </div>

            <div>
                <label class="text-[0.6rem] uppercase font-bold text-gray-500 block mb-1">Copies</label>
                <select id="qtySelect" onchange="calculatePrice()" class="bg-black border border-white/20 text-white text-xs rounded px-2 py-1">
                    <option value="20">20 Copies</option>
                    <option value="50">50 Copies</option>
                    <option value="100">100 Copies</option>
                </select>
            </div>

            <div>
                <label class="text-[0.6rem] uppercase font-bold text-gray-500 block mb-1">Font Style</label>
                <select onchange="changeFontTheme(this.value)" class="bg-black border border-white/20 text-white text-xs rounded px-2 py-1">
                    <option value="classic">Classic (Bodoni)</option>
                    <option value="modern">Modern (Sans)</option>
                    <option value="script">Elegant (Script)</option>
                </select>
            </div>
        </div>

        <div class="bg-black px-4 py-2 rounded-lg border border-white/10 flex items-center gap-4">
            <div class="text-right">
                <p class="text-[0.6rem] uppercase font-bold text-gray-400">Photo Limit</p>
                <p class="text-xs font-bold"><span id="photoCount">0</span> / 5 Free</p>
            </div>
            <div class="h-8 w-px bg-white/20"></div>
            <div class="text-right">
                <p class="text-[0.6rem] uppercase font-bold text-gray-400">Surcharge</p>
                <p id="surchargeDisplay" class="text-xs font-bold text-green-500">£0.00</p>
            </div>
        </div>

        <div class="text-right">
            <p class="text-[0.6rem] uppercase font-bold text-gray-500">Total Estimate</p>
            <p id="totalPrice" class="text-xl font-bold text-[#C5A059]">£80.00</p>
        </div>

    </div>

    <div class="flex-1 bg-[#111] flex flex-col relative overflow-hidden">
        
        <div class="h-12 bg-white/5 border-b border-white/5 flex items-center justify-center gap-4 text-xs">
            <span class="text-gray-400 uppercase font-bold tracking-widest" id="spreadLabel">Cover & Back</span>
            <div class="h-4 w-px bg-white/10"></div>
            <div class="flex gap-2" id="layout-controls">
                </div>
        </div>

        <div class="flex-1 flex items-center justify-center p-8 overflow-y-auto">
            
            <button onclick="prevSpread()" class="absolute left-4 top-1/2 text-white/20 hover:text-[#C5A059] text-4xl transition-colors"><i class="fas fa-chevron-left"></i></button>

            <div id="spread-container" class="spread-container font-classic transition-all duration-500">
                
                <div id="page-left" class="page-a5 page-left p-8">
                    </div>

                <div id="page-right" class="page-a5 page-right p-8">
                    </div>

                <div class="absolute inset-y-0 left-1/2 w-16 -ml-8 bg-gradient-to-r from-transparent via-black/10 to-transparent pointer-events-none"></div>
            </div>

            <button onclick="nextSpread()" class="absolute right-4 top-1/2 text-white/20 hover:text-[#C5A059] text-4xl transition-colors"><i class="fas fa-chevron-right"></i></button>

        </div>

        <div class="h-16 flex items-center justify-center gap-4 pb-4" id="navDots">
            </div>

    </div>

    <input type="file" id="globalPhotoInput" accept="image/*" class="hidden">

    <script>
        // ================= STATE =================
        const state = {
            pageCount: 4,
            currentSpread: 0, // 0 = Cover/Back, 1 = Pages 2-3, etc.
            qty: 20,
            photoLimit: 5,
            extraPhotoCost: 7.50,
            pages: [] // Array of Page Objects
        };

        // Page Layout Templates
        const TEMPLATES = {
            'cover': `<div class="h-full flex flex-col items-center justify-center text-center">
                        <div class="editable-text text-sm uppercase tracking-widest mb-4" contenteditable="true">In Loving Memory of</div>
                        <div class="photo-slot w-48 h-48 rounded-full mb-6 border-4 border-double border-gray-200" onclick="triggerPhotoUpload(this)">
                            <i class="fas fa-camera text-2xl"></i>
                        </div>
                        <h1 class="editable-text text-4xl mb-2 w-full" contenteditable="true">Name Here</h1>
                        <p class="editable-text text-sm w-full" contenteditable="true">1950 - 2026</p>
                        <div class="mt-8 text-xs uppercase tracking-widest editable-text" contenteditable="true">St Mary's Church</div>
                      </div>`,
            
            'back': `<div class="h-full flex flex-col items-center justify-end text-center pb-10">
                        <div class="photo-slot w-24 h-24 mb-6" onclick="triggerPhotoUpload(this)"><i class="fas fa-camera"></i></div>
                        <h3 class="editable-text text-lg mb-2" contenteditable="true">Donations</h3>
                        <p class="editable-text text-xs text-gray-600 w-3/4 mb-8" contenteditable="true">Donations in memory may be made to The Hospice Charity.</p>
                        <p class="text-[10px] text-gray-400">Printed by FuneralMatch</p>
                     </div>`,

            'text': `<div class="h-full p-4">
                        <h2 class="editable-text text-xl font-bold border-b border-gray-200 pb-2 mb-4" contenteditable="true">Reading / Hymn</h2>
                        <div class="editable-text text-sm leading-loose whitespace-pre-wrap" contenteditable="true">
Paste your hymn lyrics, reading, or eulogy text here...
                        </div>
                     </div>`,

            'photo-top': `<div class="h-full flex flex-col">
                            <div class="photo-slot h-1/2 w-full mb-4" onclick="triggerPhotoUpload(this)"><i class="fas fa-camera mr-2"></i> Add Photo</div>
                            <h2 class="editable-text text-xl font-bold mb-2" contenteditable="true">Title</h2>
                            <div class="editable-text text-sm" contenteditable="true">Write caption here...</div>
                          </div>`,

            'photo-full': `<div class="h-full w-full p-0">
                             <div class="photo-slot w-full h-full" onclick="triggerPhotoUpload(this)"><i class="fas fa-expand mr-2"></i> Full Page Photo</div>
                           </div>`
        };

        // ================= INIT =================
        function init() {
            generatePages(4);
            renderSpread();
            calculatePrice();
        }

        // ================= LOGIC =================
        
        function updatePageCount(val) {
            const newCount = parseInt(val);
            if(confirm("Changing page count will reset layouts. Continue?")) {
                state.pageCount = newCount;
                state.currentSpread = 0; // Reset to cover
                generatePages(newCount);
                renderSpread();
                calculatePrice();
            }
        }

        function generatePages(count) {
            state.pages = [];
            
            // Logic: 
            // Index 0 = Back Cover (Left of Spread 0)
            // Index 1 = Front Cover (Right of Spread 0)
            // Index 2..n-1 = Inner Pages
            
            // 0: Back Cover
            state.pages.push({ id: 0, html: TEMPLATES['back'], type: 'back' });
            // 1: Front Cover
            state.pages.push({ id: 1, html: TEMPLATES['cover'], type: 'cover' });

            // Inner Pages (2 to count-1)
            for(let i=2; i < count; i++) {
                state.pages.push({ id: i, html: TEMPLATES['text'], type: 'inner' });
            }
            
            renderNavDots();
        }

        function renderNavDots() {
            const container = document.getElementById('navDots');
            container.innerHTML = '';
            
            // Calculate number of spreads:
            // Spread 0: Back (0) + Front (1)
            // Spread 1: Page 2 + Page 3
            // Spread 2: Page 4 + Page 5...
            const totalSpreads = (state.pageCount / 2); 

            for(let i=0; i < totalSpreads; i++) {
                const dot = document.createElement('div');
                dot.className = `nav-dot ${i === state.currentSpread ? 'active' : ''}`;
                dot.title = i === 0 ? "Cover" : `Pages ${i*2} & ${i*2+1}`;
                dot.onclick = () => jumpToSpread(i);
                container.appendChild(dot);
            }
        }

        function jumpToSpread(index) {
            saveCurrentSpreadState();
            state.currentSpread = index;
            renderSpread();
            renderNavDots(); // update active class
        }

        function nextSpread() {
            const max = (state.pageCount / 2) - 1;
            if(state.currentSpread < max) jumpToSpread(state.currentSpread + 1);
        }

        function prevSpread() {
            if(state.currentSpread > 0) jumpToSpread(state.currentSpread - 1);
        }

        function saveCurrentSpreadState() {
            // Save HTML from DOM back to state array before navigating away
            if (state.currentSpread === 0) {
                state.pages[0].html = document.getElementById('page-left').innerHTML;
                state.pages[1].html = document.getElementById('page-right').innerHTML;
            } else {
                // Determine page indices
                const pLeft = state.currentSpread * 2;
                const pRight = pLeft + 1;
                if(state.pages[pLeft]) state.pages[pLeft].html = document.getElementById('page-left').innerHTML;
                if(state.pages[pRight]) state.pages[pRight].html = document.getElementById('page-right').innerHTML;
            }
            countPhotos(); // Recalculate photos on save
        }

        function renderSpread() {
            const leftDiv = document.getElementById('page-left');
            const rightDiv = document.getElementById('page-right');
            const label = document.getElementById('spreadLabel');
            const controls = document.getElementById('layout-controls');

            // Clear Controls
            controls.innerHTML = `
                <span class="text-gray-500 mr-2">Apply Layout to Page:</span>
                <button class="layout-btn" onclick="applyTemplate('text')">Text</button>
                <button class="layout-btn" onclick="applyTemplate('photo-top')">Photo Top</button>
                <button class="layout-btn" onclick="applyTemplate('photo-full')">Full Photo</button>
                <button class="layout-btn" onclick="applyTemplate('text')">Hymn</button>
            `;

            if (state.currentSpread === 0) {
                // SPECIAL CASE: Cover Spread
                // Left = Back Cover (Index 0)
                // Right = Front Cover (Index 1)
                label.innerText = "Back Cover & Front Cover";
                leftDiv.innerHTML = state.pages[0].html;
                rightDiv.innerHTML = state.pages[1].html;
                
                // Disable standard layout controls for covers to prevent breaking design
                controls.innerHTML = '<span class="text-gray-600 italic">Cover layouts are fixed</span>';
                
            } else {
                // Inner Spreads
                const pLeft = state.currentSpread * 2;
                const pRight = pLeft + 1;
                
                label.innerText = `Pages ${pLeft} & ${pRight}`;
                
                leftDiv.innerHTML = state.pages[pLeft] ? state.pages[pLeft].html : '';
                rightDiv.innerHTML = state.pages[pRight] ? state.pages[pRight].html : '';
            }
        }

        // ================= TEMPLATE SYSTEM =================
        // In a real app, we'd need to know WHICH page (left or right) the user wants to change.
        // For this demo, we'll apply it to the RIGHT page by default as it's the primary reading page, 
        // or toggle based on click focus. Simplified here to apply to Right Page.
        function applyTemplate(type) {
            if(state.currentSpread === 0) return; // Cant change covers
            const pRight = (state.currentSpread * 2) + 1;
            
            if(confirm("Replace content on Right Page with this template?")) {
                document.getElementById('page-right').innerHTML = TEMPLATES[type];
                calculatePrice(); // Re-check photo counts
            }
        }

        // ================= PHOTO HANDLING =================
        let currentPhotoSlot = null;

        function triggerPhotoUpload(element) {
            currentPhotoSlot = element;
            document.getElementById('globalPhotoInput').click();
        }

        document.getElementById('globalPhotoInput').onchange = function(e) {
            if(e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    if(currentPhotoSlot) {
                        currentPhotoSlot.innerHTML = `<img src="${evt.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
                        currentPhotoSlot.classList.remove('bg-gray-200'); // Remove placeholder styling
                        saveCurrentSpreadState(); // Save immediately
                        calculatePrice(); // Check limits
                    }
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        function countPhotos() {
            // Scan ALL pages in memory for <img> tags
            let total = 0;
            state.pages.forEach(page => {
                // Simple regex to count img tags in the HTML string
                const count = (page.html.match(/<img/g) || []).length;
                total += count;
            });
            return total;
        }

        // ================= PRICING =================
        function calculatePrice() {
            // 1. Base Cost (Qty)
            state.qty = parseInt(document.getElementById('qtySelect').value);
            let base = 80; // 20 copies
            if(state.qty === 50) base = 140;
            if(state.qty === 100) base = 220;

            // 2. Page Count Cost
            let pageCost = 0;
            if (state.pageCount === 8) pageCost = 40;
            if (state.pageCount === 12) pageCost = 80;
            if (state.pageCount === 16) pageCost = 120;

            // 3. Photo Surcharge
            const usedPhotos = countPhotos();
            document.getElementById('photoCount').innerText = usedPhotos;
            
            let surcharge = 0;
            const display = document.getElementById('surchargeDisplay');
            
            if (usedPhotos > state.photoLimit) {
                const extra = usedPhotos - state.photoLimit;
                surcharge = extra * state.extraPhotoCost;
                display.innerText = `+£${surcharge.toFixed(2)}`;
                display.classList.remove('text-green-500');
                display.classList.add('text-red-500');
            } else {
                display.innerText = "£0.00";
                display.classList.add('text-green-500');
                display.classList.remove('text-red-500');
            }

            // Total
            const total = base + pageCost + surcharge;
            document.getElementById('totalPrice').innerText = `£${total.toFixed(2)}`;
        }

        function changeFontTheme(theme) {
            const container = document.getElementById('spread-container');
            container.className = `spread-container font-${theme} transition-all duration-500`;
        }

        // Run
        init();

    </script>
</body>
</html>
