<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrangement Studio | Funeral Match</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --deep-slate: #121416; --card-bg: #1C1F22; --gold: #B39359; 
            --white: #F4F4F4; --text-dim: #8A8F98; --border: rgba(255, 255, 255, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--deep-slate); color: var(--white); -webkit-font-smoothing: antialiased; }

        .header { padding: 25px; text-align: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--deep-slate); z-index: 100; }
        .progress-track { width: 100%; max-width: 500px; height: 4px; background: var(--border); margin: 15px auto; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gold); transition: 0.5s ease; width: 10%; }
        
        .container { max-width: 700px; margin: 0 auto; padding: 40px 20px 180px; }
        h1 { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 10px; text-align: center; }
        .desc { color: var(--text-dim); text-align: center; margin-bottom: 30px; font-size: 0.85rem; line-height: 1.5; }

        .option-grid { display: flex; flex-direction: column; gap: 12px; }
        .card { 
            background: var(--card-bg); border: 1px solid var(--border); padding: 20px; 
            border-radius: 16px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px;
        }
        .card.active { border-color: var(--gold); background: rgba(179, 147, 89, 0.08); }
        .price { margin-left: auto; color: var(--gold); font-weight: 600; font-size: 0.9rem; }

        .bespoke-input { width: 100%; background: #000; border: 1px dashed var(--gold); padding: 15px; border-radius: 12px; color: white; margin-top: 10px; outline: none; }
        
        .qty-selector { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .qty-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--gold); background: transparent; color: var(--gold); cursor: pointer; font-size: 1.2rem; }

        .footer { position: fixed; bottom: 0; width: 100%; background: rgba(18, 20, 22, 0.98); backdrop-filter: blur(15px); padding: 25px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        .total-val { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--gold); }
        .btn-next { background: var(--gold); color: #000; padding: 16px 35px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div id="stepTag" style="font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--gold);">Step 1 of 10</div>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
</div>

<div class="container" id="mainStage"></div>

<div class="footer">
    <div>
        <span style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-dim);">Live Est. Total</span>
        <div class="total-val" id="displayTotal">£0</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn-next" style="background:#222; color:white" onclick="prevStep()">Back</button>
        <button class="btn-next" onclick="nextStep()" id="mainNextBtn">Continue</button>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    let basePrice = parseInt(urlParams.get('base')) || 2500;
    let currentStep = 1;
    let stepChoices = {}; 

    const arrangementData = {
        1: { title: "Method", desc: "Choose the type of committal.", options: [{ name: "Cremation", price: 0, slug: 'cremation' }, { name: "Traditional Burial", price: 1500, slug: 'burial' }, { name: "Burial at Sea", price: 3200, slug: 'sea' }] },
        2: { title: "Attendance", desc: "Burials and Sea Burials must be attended.", options: [{ name: "Direct (Unattended)", price: 0, slug: 'direct' }, { name: "Attended Service", price: 600, slug: 'attended' }] },
        3: { title: "Coffins & Caskets", desc: "Extensive range of choices.", options: [{ name: "Oak Veneer", price: 0 }, { name: "Willow Woven", price: 550 }, { name: "Solid Mahogany", price: 1200 }, { name: "Specialist Sea Casket", price: 1450 }] },
        4: { title: "Vehicles", desc: "Standard hearse or bespoke request (Ferrari, Bus, Land Rover).", type: "vehicles" },
        5: { title: "Care of Deceased", desc: "Select all that apply for the care and preparation.", type: "multi", options: [{ name: "Full Embalming", price: 250 }, { name: "Private Viewing", price: 150 }, { name: "Dressing in Own Clothes", price: 50 }] },
        6: { title: "The Service", desc: "Build your combined service sequence.", type: "multi", options: [{ name: "Service at Church Before", price: 350 }, { name: "Procession from Home", price: 150 }, { name: "Celebrant Led", price: 250 }, { name: "Wake / Reception", price: 0 }] },
        7: { title: "Orders of Service", desc: "Stationery starting at 20 copies (£80).", type: "stationery" },
        8: { title: "Floral Tributes", desc: "Select a curated package deal.", options: [{ name: "No Flowers", price: 0 }, { name: "Small Package", price: 120 }, { name: "Medium Package", price: 280 }, { name: "Large Package", price: 450 }] },
        9: { title: "Admin & Notices", desc: "Mandatory third-party and legal fees.", type: "admin" },
        10: { title: "Memorials", desc: "Select all long-term tribute options.", type: "multi", options: [{ name: "Grave Stone", price: 1200 }, { name: "Memorial Bench", price: 600 }, { name: "Ashes Jewelry", price: 250 }, { name: "Keepsake Urn", price: 85 }, { name: "Other (POA)", price: 0 }] }
    };

    function renderStep() {
        const stage = document.getElementById('mainStage');
        const data = arrangementData[currentStep];
        const method = stepChoices[1]?.slug;

        if (currentStep === 2 && (method === 'burial' || method === 'sea')) {
            stepChoices[2] = { name: "Attended Service", price: 600, slug: 'attended' };
            currentStep = 3; renderStep(); return;
        }

        document.getElementById('stepTag').innerText = `Step ${currentStep} of 10`;
        document.getElementById('progressFill').style.width = `${currentStep * 10}%`;

        let html = `<h1>${data.title}</h1><p class="desc">${data.desc}</p>`;

        if (currentStep === 4 && stepChoices[2]?.slug === 'direct') {
            html += `<div class="card active"><h3>Private Ambulance</h3><div class="price">Included</div></div>`;
            stepChoices[4] = { name: "Private Ambulance", price: 0, limos: 0 };
        } else if (data.type === 'vehicles') {
            const limos = stepChoices[4]?.limos || 0;
            html += `<div class="option-grid">
                <div class="card ${stepChoices[4]?.name==='Standard'?'active':''}" onclick="setVeh('Standard', 0)"><h3>Standard Hearse</h3><div class="price">Incl.</div></div>
                <div class="card ${stepChoices[4]?.name==='Horse'?'active':''}" onclick="setVeh('Horse', 1000)"><h3>Horse Drawn</h3><div class="price">+£1,000</div></div>
                <div class="card ${stepChoices[4]?.bespoke?'active':''}" onclick="setVeh('Bespoke', 0, true)"><h3>Bespoke Request</h3><div class="price">POA</div></div>
                ${stepChoices[4]?.bespoke ? `<input type="text" class="bespoke-input" placeholder="Ferrari, Bus, Land Rover..." oninput="stepChoices[4].req=this.value" value="${stepChoices[4].req||''}">` : ''}
                <div class="card active" style="margin-top:15px; display:block">
                    <p style="font-size:0.8rem">Limousines (+£250 ea)</p>
                    <div class="qty-selector"><button class="qty-btn" onclick="updLimo(-1)">-</button><span>${limos}</span><button class="qty-btn" onclick="updLimo(1)">+</button></div>
                </div>
            </div>`;
        } else if (data.type === 'multi') {
            if(!stepChoices[currentStep]) stepChoices[currentStep] = [];
            html += `<div class="option-grid">` + data.options.map(opt => `
                <div class="card ${stepChoices[currentStep].some(c=>c.name===opt.name)?'active':''}" onclick="toggleMulti('${opt.name}', ${opt.price})">
                    <h3>${opt.name}</h3><div class="price">${opt.price>0?'+£'+opt.price:'POA'}</div>
                </div>`).join('') + `</div>`;
        } else if (data.type === 'stationery') {
            const qty = stepChoices[7]?.qty || 20;
            const price = 80 + (Math.max(0, (qty-20)/10)*15);
            html += `<div class="card active" style="flex-direction:column; padding:30px">
                <h2 style="color:var(--gold)">${qty} Copies</h2>
                <div class="qty-selector"><button class="qty-btn" onclick="updStat(-10)">-</button><button class="qty-btn" onclick="updStat(10)">+</button></div>
                <p style="margin-top:15px">Total Stationery: £${price}</p>
            </div>`;
        } else if (data.type === 'admin') {
            html += `<div class="option-grid">
                <div class="card active"><h3>Professional Fee</h3><div class="price">£1,200</div></div>
                <div class="card active"><h3>Doctor's Fees</h3><div class="price">£164</div></div>
                <div class="card active"><h3>Legal Admin</h3><div class="price">£150</div></div>
            </div>`;
            stepChoices[9] = { price: 1514, name: "Admin & Legal Fees" }; 
        } else {
            html += `<div class="option-grid">` + data.options.map(opt => `
                <div class="card ${stepChoices[currentStep]?.name===opt.name?'active':''}" onclick="setSingle('${opt.name}', ${opt.price}, '${opt.slug||''}')">
                    <h3>${opt.name}</h3><div class="price">${opt.price>0?'+£'+opt.price:'Incl.'}</div>
                </div>`).join('') + `</div>`;
        }
        stage.innerHTML = html;
        updateTotal();
    }

    function setSingle(name, price, slug) { stepChoices[currentStep] = { name, price, slug }; renderStep(); }
    function toggleMulti(name, price) {
        let arr = stepChoices[currentStep] || [];
        const idx = arr.findIndex(i => i.name === name);
        if(idx > -1) arr.splice(idx, 1); else arr.push({name, price});
        stepChoices[currentStep] = arr; renderStep();
    }
    function setVeh(name, price, bespoke=false) { stepChoices[4] = { name, price, bespoke, limos: stepChoices[4]?.limos||0 }; renderStep(); }
    function updLimo(v) { if(!stepChoices[4]) setVeh('Standard', 0); stepChoices[4].limos = Math.max(0, stepChoices[4].limos + v); renderStep(); }
    function updStat(v) { 
        const cur = stepChoices[7]?.qty || 20;
        const n = Math.min(250, Math.max(20, cur + v));
        stepChoices[7] = { name: n + ' Copies', qty: n, price: 80 + ((n-20)/10*15) }; renderStep(); 
    }

    function updateTotal() {
        let extra = 0;
        Object.keys(stepChoices).forEach(k => {
            const val = stepChoices[k];
            if(Array.isArray(val)) val.forEach(v => extra += v.price);
            else if(val) {
                extra += val.price || 0;
                if(k == 4) extra += (val.limos * 250);
            }
        });
        document.getElementById('displayTotal').innerText = `£${(basePrice + extra).toLocaleString()}`;
    }

    function nextStep() {
        if(currentStep < 10) { 
            currentStep++; renderStep(); window.scrollTo(0,0); 
        } else { 
            localStorage.setItem('funeralArrangement', JSON.stringify({ basePrice, steps: stepChoices }));
            window.location.href = 'review.html'; 
        }
    }
    function prevStep() { if(currentStep > 1) { currentStep--; renderStep(); } }

    renderStep();
</script>
</body>
</html>
