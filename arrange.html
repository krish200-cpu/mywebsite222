<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FuneralOS | Professional</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        slate: { 850: '#151b28', 900: '#0e121b' },
                        brand: { 500: '#C5A059', 600: '#B08D4B' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.04)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F8F9FA; color: #111827; }
        
        /* MODERN SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }

        /* INPUT STYLING (MODERN & CLEAN) */
        .input-group { position: relative; margin-bottom: 24px; }
        .input-label { 
            position: absolute; top: -10px; left: 12px; background: #F8F9FA; padding: 0 4px;
            font-size: 11px; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; z-index: 10;
        }
        .input-field {
            width: 100%; background: transparent; border: 1px solid #E5E7EB; border-radius: 8px;
            padding: 14px 16px; font-size: 14px; font-weight: 500; color: #111827;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-field:focus { border-color: #C5A059; box-shadow: 0 0 0 1px #C5A059; outline: none; background: white; }
        .input-field:disabled { background: #F3F4F6; cursor: not-allowed; opacity: 0.7; }

        /* SEGMENTED CONTROL */
        .segment-group { display: flex; background: #E5E7EB; padding: 4px; border-radius: 10px; }
        .segment-btn { 
            flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: 600; border-radius: 7px; color: #6B7280; transition: all 0.2s; 
        }
        .segment-btn.active { background: white; color: #111827; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* GLASS CARD */
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); box-shadow: var(--theme-shadow-glass); }
        
        /* TRANSITIONS */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen overflow-hidden">

<div id="app" class="flex h-full w-full">

    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-20 shrink-0 hidden md:flex">
        <div class="h-20 flex items-center px-6 border-b border-gray-100">
            <img v-if="brand.logo" :src="brand.logo" class="h-8 max-w-[150px] object-contain">
            <div v-else class="flex items-center gap-3">
                <div class="w-8 h-8 bg-brand-500 rounded flex items-center justify-center text-white font-bold">F</div>
                <span class="font-bold tracking-tight text-slate-900">FuneralOS</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-1">
            <div class="text-[10px] font-bold text-gray-400 uppercase px-3 mb-2 mt-2">Arrangement Flow</div>
            
            <template v-for="item in nav" :key="item.id">
                <button @click="currentStep = item.id"
                    class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm transition-all"
                    :class="currentStep === item.id ? 'bg-gray-100 text-slate-900 font-semibold' : 'text-gray-500 hover:bg-gray-50'">
                    <div class="flex items-center gap-3">
                        <i :class="item.icon" class="text-lg"></i>
                        {{ item.label }}
                    </div>
                    <i v-if="completedSteps.includes(item.id)" class="ph-check-circle-fill text-green-500"></i>
                </button>
            </template>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <button @click="showSettings = true" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-500 hover:text-slate-900 transition">
                <i class="ph-gear text-lg"></i> System Settings
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-[#F8F9FA] relative">
        
        <header class="h-16 bg-white/80 backdrop-blur border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <button @click="toggleMobileMenu" class="md:hidden text-2xl text-gray-500"><i class="ph-list"></i></button>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="font-semibold text-slate-900">{{ currentStepLabel }}</h1>
                        <span v-if="tbcMode" class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded border border-yellow-200">TBC MODE ACTIVE</span>
                    </div>
                    <div class="text-xs text-gray-400 font-mono">REF: {{ meta.ref }}</div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                 <div class="text-right hidden sm:block">
                    <div class="text-[10px] font-bold text-gray-400 uppercase">Estimate</div>
                    <div class="font-mono font-bold text-slate-900">{{ formattedTotal }}</div>
                </div>
                <button @click="generatePDF" class="bg-slate-900 text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm hover:bg-black transition flex items-center gap-2">
                    <i class="ph-file-pdf"></i> Contract
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-10 pb-32">
            <transition name="fade" mode="out-in">
                
                <div v-if="currentStep === 'intake'" class="max-w-3xl mx-auto space-y-8" key="intake">
                    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8">
                        <h2 class="text-lg font-semibold text-slate-900 mb-6 flex items-center gap-2"><i class="ph-user-focus text-brand-500"></i> The Deceased</h2>
                        
                        <div class="grid grid-cols-12 gap-5">
                            <div class="col-span-3 md:col-span-2">
                                <div class="input-group">
                                    <label class="input-label">Title</label>
                                    <select v-model="form.deceased.title" class="input-field"><option>Mr</option><option>Mrs</option><option>Ms</option><option>Dr</option></select>
                                </div>
                            </div>
                            <div class="col-span-9 md:col-span-5">
                                <div class="input-group">
                                    <label class="input-label">First Name</label>
                                    <input v-model="form.deceased.firstName" class="input-field">
                                </div>
                            </div>
                            <div class="col-span-12 md:col-span-5">
                                <div class="input-group">
                                    <label class="input-label">Surname</label>
                                    <input v-model="form.deceased.lastName" class="input-field">
                                </div>
                            </div>
                            <div class="col-span-6">
                                <div class="input-group">
                                    <label class="input-label">Date of Death</label>
                                    <input type="date" v-model="form.deceased.dod" class="input-field">
                                </div>
                            </div>
                            <div class="col-span-6">
                                <div class="input-group">
                                    <label class="input-label">Date of Birth</label>
                                    <input type="date" v-model="form.deceased.dob" class="input-field">
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-8 border-t border-gray-100">
                            <h3 class="text-sm font-bold text-gray-500 uppercase mb-4">Legal & Certification</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 rounded-lg border border-gray-200 bg-gray-50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-slate-700">Registrar's Certificate (Green Form)</span>
                                        <input type="checkbox" v-model="form.legal.greenForm" class="w-5 h-5 accent-green-600">
                                    </div>
                                    <p class="text-xs text-gray-500">Required for collection in most cases.</p>
                                </div>
                                <div class="p-4 rounded-lg border border-gray-200 bg-gray-50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-slate-700">Coroner Involved (Form 6)</span>
                                        <input type="checkbox" v-model="form.legal.coroner" class="w-5 h-5 accent-blue-600">
                                    </div>
                                    <input v-if="form.legal.coroner" v-model="form.legal.coronerRef" placeholder="Coroner Ref #" class="mt-2 w-full text-xs p-2 border rounded">
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <div v-else-if="currentStep === 'arrange'" class="max-w-4xl mx-auto space-y-6" key="arrange">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div v-for="svc in inventory.services" :key="svc.id" 
                             @click="form.arrange.serviceId = svc.id"
                             class="bg-white border rounded-xl p-6 cursor-pointer transition hover:shadow-md relative overflow-hidden"
                             :class="form.arrange.serviceId === svc.id ? 'border-brand-500 ring-1 ring-brand-500' : 'border-gray-200'">
                            <div v-if="form.arrange.serviceId === svc.id" class="absolute top-0 right-0 p-2 bg-brand-500 text-white rounded-bl-xl"><i class="ph-check-bold"></i></div>
                            <div class="font-serif text-xl font-medium text-slate-900 mb-1">{{ svc.name }}</div>
                            <div class="text-xs text-gray-500 mb-4 h-8">{{ svc.desc }}</div>
                            <div class="font-mono font-bold text-slate-700">£{{ svc.price }}</div>
                        </div>
                    </div>

                    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                         <h2 class="text-lg font-semibold text-slate-900 mb-6">Casket Selection</h2>
                         <div class="flex gap-4 overflow-x-auto pb-4">
                             <div v-for="casket in inventory.caskets" :key="casket.id"
                                  @click="form.arrange.casketId = casket.id"
                                  class="min-w-[200px] border rounded-lg p-4 cursor-pointer text-center relative"
                                  :class="form.arrange.casketId === casket.id ? 'border-brand-500 bg-brand-50' : 'border-gray-200'">
                                  <div class="h-24 bg-gray-100 rounded mb-3 flex items-center justify-center text-gray-300 text-4xl"><i class="ph-archive-box"></i></div>
                                  <div class="text-sm font-bold text-slate-900">{{ casket.name }}</div>
                                  <div class="text-xs text-gray-500">£{{ casket.price }}</div>
                             </div>
                         </div>
                    </section>
                </div>

                <div v-else-if="currentStep === 'logistics'" class="max-w-3xl mx-auto space-y-6" key="logistics">
                    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-semibold text-slate-900">Fleet Requirements</h2>
                            <label class="flex items-center gap-2 cursor-pointer text-xs font-bold text-gray-500">
                                <input type="checkbox" v-model="form.logistics.tbc" class="accent-brand-500"> MARK ALL TBC
                            </label>
                        </div>

                        <div class="space-y-6" :class="{'opacity-50 pointer-events-none': form.logistics.tbc}">
                            <div class="flex items-center justify-between border-b border-gray-100 pb-6">
                                <div>
                                    <div class="font-medium text-slate-900">Principal Hearse</div>
                                    <div class="text-xs text-gray-500">Motor Hearse included in Professional Fee</div>
                                </div>
                                <div class="segment-group w-48">
                                    <button @click="form.logistics.hearse = 'motor'" class="segment-btn" :class="{'active': form.logistics.hearse === 'motor'}">Motor</button>
                                    <button @click="form.logistics.hearse = 'horse'" class="segment-btn" :class="{'active': form.logistics.hearse === 'horse'}">Horse</button>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-slate-900">Limousines</div>
                                    <div class="text-xs text-gray-500">Mercedes E-Class (7 Seats) • £275 ea</div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button @click="form.logistics.limos = Math.max(0, form.logistics.limos - 1)" class="w-8 h-8 rounded border border-gray-300 flex items-center justify-center hover:bg-gray-50">-</button>
                                    <span class="w-8 text-center font-mono font-bold">{{ form.logistics.limos }}</span>
                                    <button @click="form.logistics.limos = form.logistics.limos + 1" class="w-8 h-8 rounded border border-gray-300 flex items-center justify-center hover:bg-gray-50">+</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                         <h2 class="text-lg font-semibold text-slate-900 mb-6">Service Locations</h2>
                         <div class="space-y-4">
                             <div class="input-group">
                                 <label class="input-label">Collection From</label>
                                 <input v-model="form.logistics.collection" class="input-field" placeholder="Full Address">
                             </div>
                             <div class="input-group">
                                 <label class="input-label">Service Venue</label>
                                 <input v-model="form.logistics.venue" class="input-field">
                             </div>
                         </div>
                    </section>
                </div>

                <div v-else-if="currentStep === 'finance'" class="max-w-3xl mx-auto space-y-6" key="finance">
                    <div class="bg-slate-900 text-white p-8 rounded-xl shadow-lg flex justify-between items-center">
                        <div>
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Total Outstanding</div>
                            <div class="text-4xl font-mono text-brand-500">{{ formattedTotal }}</div>
                        </div>
                         <button @click="generatePDF" class="bg-white text-slate-900 px-6 py-3 rounded-lg text-sm font-bold shadow-lg hover:bg-gray-100 transition">
                            Finalize Arrangement
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                                <tr><th class="p-4 text-left">Description</th><th class="p-4 text-right">Cost</th></tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr><td class="p-4">Professional Fees & Administration</td><td class="p-4 text-right font-mono">£1,200.00</td></tr>
                                <tr v-if="selectedService"><td class="p-4">{{ selectedService.name }}</td><td class="p-4 text-right font-mono">£{{ selectedService.price }}</td></tr>
                                <tr v-if="selectedCasket"><td class="p-4">{{ selectedCasket.name }}</td><td class="p-4 text-right font-mono">£{{ selectedCasket.price }}</td></tr>
                                <tr v-if="form.logistics.limos"><td class="p-4">Limousines (x{{ form.logistics.limos }})</td><td class="p-4 text-right font-mono">£{{ form.logistics.limos * 275 }}</td></tr>
                                <tr v-if="form.logistics.hearse === 'horse'"><td class="p-4">Horse Drawn Upgrade</td><td class="p-4 text-right font-mono">£950.00</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </transition>
        </div>

    </main>

    <div v-if="showSettings" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-6 m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold">System Settings</h2>
                <button @click="showSettings = false" class="text-gray-400 hover:text-black"><i class="ph-x text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="input-label relative top-0 mb-1">Company Logo URL</label>
                    <input v-model="brand.logo" placeholder="https://..." class="input-field">
                    <p class="text-[10px] text-gray-500 mt-1">Paste a link to your logo. It will auto-save.</p>
                </div>
                <div v-if="brand.logo" class="p-4 border border-gray-200 rounded-lg flex justify-center bg-gray-50">
                    <img :src="brand.logo" class="h-12 object-contain">
                </div>
                <button @click="saveSettings" class="w-full py-3 bg-brand-500 text-white font-bold rounded-lg hover:bg-brand-600 transition">Save Configuration</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, ref, onMounted, watch } = Vue;

    createApp({
        setup() {
            // STATE
            const currentStep = ref('intake');
            const showSettings = ref(false);
            const brand = reactive({ logo: '' });
            
            const meta = reactive({
                ref: `Ref-${new Date().getFullYear()}-${Math.floor(Math.random() * 9999)}`
            });

            // NAV TREE
            const nav = [
                { id: 'intake', label: 'Intake & Legal', icon: 'ph-user' },
                { id: 'arrange', label: 'Arrangement', icon: 'ph-scroll' },
                { id: 'logistics', label: 'Fleet & Ops', icon: 'ph-car' },
                { id: 'finance', label: 'Finance', icon: 'ph-currency-gbp' }
            ];

            // DATA STORE
            const form = reactive({
                deceased: { title: 'Mr', firstName: '', lastName: '', dob: '', dod: '' },
                legal: { greenForm: false, coroner: false, coronerRef: '' },
                arrange: { serviceId: 'simple', casketId: 'std' },
                logistics: { hearse: 'motor', limos: 0, collection: '', venue: '', tbc: false }
            });

            // INVENTORY
            const inventory = {
                services: [
                    { id: 'direct', name: 'Direct Cremation', price: 995, desc: 'Unattended.' },
                    { id: 'simple', name: 'Simple Service', price: 2200, desc: 'Hearse only.' },
                    { id: 'trad', name: 'Traditional', price: 2950, desc: 'Full Cortege.' }
                ],
                caskets: [
                    { id: 'std', name: 'Morpeth Oak', price: 0 },
                    { id: 'willow', name: 'Natural Willow', price: 650 },
                    { id: 'solid', name: 'Solid Mahogany', price: 1400 }
                ]
            };

            // COMPUTED
            const selectedService = computed(() => inventory.services.find(s => s.id === form.arrange.serviceId));
            const selectedCasket = computed(() => inventory.caskets.find(c => c.id === form.arrange.casketId));
            
            const totalCost = computed(() => {
                let total = 1200;
                if(selectedService.value) total += selectedService.value.price;
                if(selectedCasket.value) total += selectedCasket.value.price;
                total += (form.logistics.limos * 275);
                if(form.logistics.hearse === 'horse') total += 950;
                return total;
            });

            const formattedTotal = computed(() => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(totalCost.value));
            
            const currentStepLabel = computed(() => nav.find(n => n.id === currentStep.value)?.label);
            
            const completedSteps = computed(() => {
                const s = [];
                if(form.deceased.lastName) s.push('intake');
                if(form.arrange.serviceId) s.push('arrange');
                return s;
            });

            // ACTIONS
            const saveSettings = () => {
                localStorage.setItem('funeral_brand_logo', brand.logo);
                showSettings.value = false;
            };

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                if(brand.logo) {
                    try { doc.addImage(brand.logo, 'JPEG', 15, 10, 30, 15); } catch(e) {}
                }
                
                doc.setFont("helvetica", "bold"); doc.setFontSize(18); doc.text("ARRANGEMENT CONTRACT", 15, 40);
                doc.setFontSize(10); doc.setFont("helvetica", "normal");
                doc.text(`Ref: ${meta.ref}`, 160, 40);

                let y = 60;
                doc.text(`Deceased: ${form.deceased.firstName} ${form.deceased.lastName}`, 15, y);
                doc.text(`Service: ${selectedService.value?.name}`, 15, y+10);
                
                doc.setFont("helvetica", "bold");
                doc.text(`TOTAL: ${formattedTotal.value}`, 15, 100);
                
                doc.save(`Arrangement-${meta.ref}.pdf`);
            };

            // INIT
            onMounted(() => {
                const savedLogo = localStorage.getItem('funeral_brand_logo');
                if(savedLogo) brand.logo = savedLogo;
            });

            return { 
                currentStep, nav, form, inventory, brand, meta, showSettings,
                selectedService, selectedCasket, formattedTotal, currentStepLabel, completedSteps,
                saveSettings, generatePDF
            };
        }
    }).mount('#app');
</script>
</body>
</html>
