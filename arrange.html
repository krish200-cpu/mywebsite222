<style>
    /* New styling for Bespoke Inputs */
    .bespoke-input {
        width: 100%; background: rgba(255,255,255,0.05); border: 1px dashed var(--gold);
        padding: 15px; border-radius: 12px; color: var(--white); margin-top: 10px;
        font-size: 0.85rem; outline: none;
    }
    .multi-tag {
        font-size: 0.6rem; background: var(--gold); color: #000; 
        padding: 2px 8px; border-radius: 4px; font-weight: 800; margin-left: 10px;
    }
</style>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    let basePrice = parseInt(urlParams.get('base')) || 2500;
    let currentStep = 1;
    let stepChoices = {}; // This now stores arrays for multi-select steps

    const arrangementData = {
        1: { title: "Method", desc: "Choose the type of committal.", options: [
            { name: "Cremation", price: 0, slug: 'cremation' }, 
            { name: "Traditional Burial", price: 1500, slug: 'burial' }, 
            { name: "Burial at Sea", price: 3200, slug: 'sea' }
        ]},
        2: { title: "Attendance", desc: "Burials and Sea Burials must be attended.", options: [
            { name: "Direct (Unattended)", price: 0, slug: 'direct' }, 
            { name: "Attended Service", price: 600, slug: 'attended' }
        ]},
        3: { title: "Coffins & Caskets", desc: "Extensive range of choices.", options: [
            { name: "Oak Veneer", price: 0 }, { name: "Willow Woven", price: 550 },
            { name: "Solid Mahogany", price: 1200 }, { name: "Specialist Sea Casket", price: 1450 }
        ]},
        4: { title: "Vehicles", desc: "Select or request bespoke transport.", type: "bespoke-vehicles" },
        5: { title: "Care of Deceased", desc: "Select all that apply.", type: "multi", options: [
            { name: "Full Embalming", price: 250 },
            { name: "Private Viewing (Chapel of Rest)", price: 150 },
            { name: "Dressing in Own Clothes", price: 50 }
        ]},
        6: { title: "The Service", desc: "Build your service sequence.", type: "multi", options: [
            { name: "Service at Church Before", price: 350 },
            { name: "Procession from Home", price: 150 },
            { name: "Celebrant Led", price: 250 },
            { name: "Wake / Reception Booking", price: 0, info: "POA" }
        ]},
        7: { title: "Orders of Service", desc: "Stationery for the day.", type: "stationery" },
        8: { title: "Floral Tributes", desc: "Select a curated package.", options: [
            { name: "No Flowers", price: 0 }, { name: "Decide Later", price: 0 },
            { name: "Small Package", price: 120 }, { name: "Medium Package", price: 280 }, { name: "Large Package", price: 450 }
        ]},
        9: { title: "Admin & Notices", desc: "Mandatory fees.", type: "admin" },
        10: { title: "Memorials", desc: "Long-term tributes.", options: [
            { name: "Grave Stone", price: 1200 }, { name: "Memorial Bench", price: 600 },
            { name: "Ashes Jewelry", price: 250 }, { name: "Request Other Memorial", price: 0 }
        ]}
    };

    function renderStep() {
        const stage = document.getElementById('mainStage');
        const data = arrangementData[currentStep];
        const method = stepChoices[1]?.slug;

        // Logic Override: Burial/Sea must be attended
        if (currentStep === 2 && (method === 'burial' || method === 'sea')) {
            stepChoices[2] = { name: "Attended Service", price: 600, slug: 'attended' };
            currentStep = 3; renderStep(); return;
        }

        // Logic Override: Direct Cremation must be Private Ambulance
        if (currentStep === 4 && stepChoices[2]?.slug === 'direct') {
            renderDirectVehicleRestriction(); return;
        }

        document.getElementById('stepTag').innerText = `Step ${currentStep} of 10`;
        document.getElementById('progressFill').style.width = `${currentStep * 10}%`;

        if (data.type === 'bespoke-vehicles') {
            renderBespokeVehicles(stage);
        } else if (data.type === 'multi') {
            renderMultiStep(data, stage);
        } else {
            // Standard render logic
            renderStandardStep(data, stage);
        }
    }

    function renderBespokeVehicles(stage) {
        stage.innerHTML = `
            <h1>${arrangementData[4].title}</h1>
            <p class="desc">Choose standard transport or request a bespoke vehicle (Bus, Ferrari, Land Rover, etc).</p>
            <div class="option-grid">
                <div class="card ${stepChoices[4]?.name === 'Standard Hearse' ? 'active' : ''}" onclick="selectVehicle('Standard Hearse', 0)">
                    <h3>Standard Hearse</h3><div class="price">Incl.</div>
                </div>
                <div class="card ${stepChoices[4]?.isBespoke ? 'active' : ''}" onclick="toggleBespoke(true)">
                    <h3>Bespoke Request</h3><div class="price">Price on Ask</div>
                </div>
                ${stepChoices[4]?.isBespoke ? `<input type="text" class="bespoke-input" id="bespokeVeh" placeholder="e.g. Vintage Route-master Bus" oninput="updateBespokeVal(this.value)" value="${stepChoices[4]?.bespokeName || ''}">` : ''}
                
                <div class="card active" style="margin-top:20px; flex-direction:column; align-items:flex-start">
                    <h3 style="font-size: 0.9rem">Limousines (+£250 each)</h3>
                    <div class="qty-selector">
                        <button class="qty-btn" onclick="updateLimo(-1)">-</button>
                        <span>${stepChoices[4]?.limos || 0}</span>
                        <button class="qty-btn" onclick="updateLimo(1)">+</button>
                    </div>
                </div>
            </div>`;
    }

    function renderMultiStep(data, stage) {
        if (!stepChoices[currentStep]) stepChoices[currentStep] = [];
        stage.innerHTML = `
            <h1>${data.title}</h1>
            <p class="desc">${data.desc}</p>
            <div class="option-grid">
                ${data.options.map((opt, i) => {
                    const isActive = stepChoices[currentStep].some(c => c.name === opt.name);
                    return `
                    <div class="card ${isActive ? 'active' : ''}" onclick="toggleMultiSelect(${i})">
                        <h3>${opt.name} ${isActive ? '<span class="multi-tag">ADDED</span>' : ''}</h3>
                        <div class="price">${opt.price > 0 ? '+£' + opt.price : 'POA'}</div>
                    </div>`;
                }).join('')}
            </div>`;
    }

    function toggleMultiSelect(index) {
        const opt = arrangementData[currentStep].options[index];
        const idx = stepChoices[currentStep].findIndex(c => c.name === opt.name);
        if (idx > -1) stepChoices[currentStep].splice(idx, 1);
        else stepChoices[currentStep].push(opt);
        updateTotal(); renderStep();
    }

    function selectVehicle(name, price) {
        stepChoices[4] = { name, price, limos: stepChoices[4]?.limos || 0, isBespoke: false };
        updateTotal(); renderStep();
    }

    function toggleBespoke(val) {
        stepChoices[4] = { name: "Bespoke Request", price: 0, limos: stepChoices[4]?.limos || 0, isBespoke: true };
        renderStep();
    }

    function updateBespokeVal(val) {
        stepChoices[4].bespokeName = val;
    }

    // [Retain calculateTotal logic, ensuring it handles the array-based multi-steps]
</script>
